@model BluesoundWeb.Pages.IndexModel
@Html.AntiForgeryToken()

<div class="index-app">
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="header-left">
                <button type="button" class="hamburger-btn" onclick="toggleMenu()" aria-label="Menu">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <div class="brand">
                    <svg class="brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                    </svg>
                    <h1>Bluesound</h1>
                </div>
            </div>
            <div class="header-actions">
                <div class="profile-indicator" onclick="toggleMenu()">
                    <span id="header-profile-initial" class="profile-initial">?</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Hamburger Menu Overlay -->
    <div id="menu-overlay" class="menu-overlay" onclick="closeMenu()"></div>

    <!-- Hamburger Menu Panel -->
    <nav id="menu-panel" class="menu-panel">
        <div class="menu-header">
            <div class="menu-profile" onclick="showProfileSwitcher()">
                <div class="menu-profile-avatar" id="menu-profile-avatar">?</div>
                <div class="menu-profile-info">
                    <span class="menu-profile-name" id="menu-profile-name">Profil</span>
                    <span class="menu-profile-switch">Profil wechseln</span>
                </div>
                <svg class="menu-profile-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </div>
        </div>
        <div class="menu-items">
            <a href="/" class="menu-item menu-item-home active" onclick="navigateTo('/'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span>Start</span>
            </a>
            <div class="menu-divider"></div>
            <a href="/TuneIn" class="menu-item" onclick="navigateTo('/TuneIn'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 12a4 4 0 0 1 8 0"/>
                    <path d="M6 12a6 6 0 0 1 12 0"/>
                </svg>
                <span>TuneIn</span>
            </a>
            <a href="/RadioParadise" class="menu-item" onclick="navigateTo('/RadioParadise'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
                <span>Radio Paradise</span>
            </a>
            <a href="/Qobuz" class="menu-item" onclick="navigateTo('/Qobuz'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <span>Qobuz</span>
            </a>
            <a href="/Players" class="menu-item" onclick="navigateTo('/Players'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 9v-2M12 17v-2M9 12H7M17 12h-2"/>
                </svg>
                <span>Players</span>
            </a>
            <div class="menu-divider"></div>
            <a href="/Settings" class="menu-item" onclick="navigateTo('/Settings'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                </svg>
                <span>Einstellungen</span>
            </a>
        </div>
    </nav>

    <!-- Profile Switcher Modal -->
    <div id="profile-switcher-overlay" class="profile-switcher-overlay" onclick="closeProfileSwitcher(event)">
        <div class="profile-switcher-modal" onclick="event.stopPropagation()">
            <div class="profile-switcher-header">
                <h3>Profil wechseln</h3>
                <button type="button" class="btn-close-modal" onclick="closeProfileSwitcher()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="profile-switcher-list" id="profile-switcher-list">
                <!-- Profiles will be rendered here -->
            </div>
            <button type="button" class="btn-add-profile" onclick="createNewProfile()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span>Neues Profil erstellen</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="index-main">
        <div class="index-container">
            <h2 class="index-title">Musik streamen</h2>
            <p class="index-subtitle">Wahle eine Quelle um loszulegen</p>

            <div class="source-grid">
                <!-- Qobuz Source -->
                <button type="button" class="source-card" onclick="selectSource('qobuz')">
                    <div class="source-icon qobuz-icon">
                        <svg viewBox="0 0 100 100" fill="currentColor">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="6"/>
                            <circle cx="50" cy="50" r="20"/>
                        </svg>
                    </div>
                    <span class="source-name">Qobuz</span>
                    <span class="source-desc">Hi-Res Streaming</span>
                </button>

                <!-- TuneIn Source -->
                <button type="button" class="source-card tunein-card" onclick="selectSource('tunein')">
                    <div class="source-icon tunein-icon">
                        <svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="5">
                            <circle cx="50" cy="50" r="45"/>
                            <path d="M30 50a20 20 0 0 1 40 0" stroke-width="4"/>
                            <path d="M20 50a30 30 0 0 1 60 0" stroke-width="4"/>
                            <circle cx="50" cy="50" r="5" fill="currentColor"/>
                        </svg>
                    </div>
                    <span class="source-name">TuneIn</span>
                    <span class="source-desc">Internet Radio</span>
                </button>

                <!-- Radio Paradise Source -->
                <button type="button" class="source-card radioparadise-card" onclick="selectSource('radioparadise')">
                    <div class="source-icon radioparadise-icon">
                        <svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="5">
                            <path d="M50 10L10 35l40 25 40-25-40-25z"/>
                            <path d="M10 65l40 25 40-25"/>
                            <path d="M10 50l40 25 40-25"/>
                        </svg>
                    </div>
                    <span class="source-name">Radio Paradise</span>
                    <span class="source-desc">Eclectic Mix</span>
                </button>
            </div>

            <!-- History Container -->
            <div id="history-container" class="history-container"></div>

            <a href="/Players" class="players-link" onclick="navigateTo('/Players'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 9v-2M12 17v-2M9 12H7M17 12h-2"/>
                </svg>
                <span>Bluesound Players verwalten</span>
            </a>
        </div>
    </main>
</div>

<style>
    /* CSS Variables */
    .index-app {
        --bg-primary: #0a0a0b;
        --bg-secondary: #111113;
        --bg-card: #161618;
        --bg-card-hover: #1c1c1f;
        --border-subtle: rgba(255, 255, 255, 0.06);
        --border-accent: rgba(255, 255, 255, 0.1);
        --text-primary: #f4f4f5;
        --text-secondary: #a1a1aa;
        --text-muted: #71717a;
        --accent-primary: #22c55e;
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 14px;
    }

    /* Index App Base */
    .index-app {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        min-height: 100dvh;
        background: var(--bg-primary);
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .index-app .app-header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-subtle);
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 0 max(16px, env(safe-area-inset-left));
        padding-top: env(safe-area-inset-top);
    }

    .index-app .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        max-width: 1200px;
        margin: 0 auto;
    }

    .index-app .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .index-app .hamburger-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: var(--radius-sm);
        transition: all 0.15s ease;
    }

    .index-app .hamburger-btn:hover {
        background: var(--bg-card);
        color: var(--text-primary);
    }

    .index-app .hamburger-btn svg {
        width: 22px;
        height: 22px;
    }

    .index-app .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .index-app .profile-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: var(--accent-primary);
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.15s ease;
    }

    .index-app .profile-indicator:hover {
        transform: scale(1.05);
    }

    .index-app .profile-initial {
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
        text-transform: uppercase;
    }

    .index-app .brand {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .index-app .brand-icon {
        width: 28px;
        height: 28px;
        color: var(--accent-primary);
    }

    .index-app .brand h1 {
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        margin: 0;
    }

    /* Main Content */
    .index-main {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        padding: 32px 16px;
        padding-bottom: calc(100px + env(safe-area-inset-bottom));
    }

    .index-container {
        text-align: center;
        max-width: 600px;
        width: 100%;
    }

    .index-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin: 0 0 6px;
        letter-spacing: -0.02em;
        color: var(--text-primary);
    }

    .index-subtitle {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin: 0 0 24px;
    }

    /* Source Grid - Compact 3-column layout */
    .source-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 28px;
    }

    .source-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
        padding: 12px 6px;
        background: var(--bg-card);
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .source-card:hover {
        background: var(--bg-card-hover);
        border-color: var(--accent-primary);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .source-card:active {
        transform: translateY(-1px);
    }

    .source-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
    }

    .source-icon svg {
        width: 22px;
        height: 22px;
    }

    .qobuz-icon {
        color: #22c55e;
        background: rgba(34, 197, 94, 0.12);
    }

    .tunein-icon {
        color: #f97316;
        background: rgba(249, 115, 22, 0.15);
    }

    .tunein-card:hover {
        border-color: #f97316;
    }

    .tunein-card:hover .source-icon {
        background: rgba(249, 115, 22, 0.2);
    }

    .radioparadise-icon {
        color: #10b981;
        background: rgba(16, 185, 129, 0.12);
    }

    .radioparadise-card:hover {
        border-color: #10b981;
    }

    .radioparadise-card:hover .source-icon {
        background: rgba(16, 185, 129, 0.18);
    }

    .source-name {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-primary);
        line-height: 1.2;
    }

    .source-desc {
        font-size: 0.65rem;
        color: var(--text-muted);
        display: none;
    }

    /* History Container */
    .history-container {
        text-align: left;
        margin-bottom: 32px;
    }

    .history-section {
        margin-bottom: 24px;
        animation: fadeInUp 0.4s ease forwards;
        opacity: 0;
    }

    .history-section:nth-child(1) { animation-delay: 0.05s; }
    .history-section:nth-child(2) { animation-delay: 0.1s; }
    .history-section:nth-child(3) { animation-delay: 0.15s; }
    .history-section:nth-child(4) { animation-delay: 0.2s; }

    @@keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(12px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .history-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin: 0 0 12px 4px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .history-title::after {
        content: '';
        flex: 1;
        height: 1px;
        background: var(--border-subtle);
    }

    .history-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
    }

    .history-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 12px 8px;
        background: var(--bg-card);
        border: 1px solid transparent;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        color: inherit;
    }

    .history-item:hover {
        background: var(--bg-card-hover);
        border-color: var(--border-accent);
        transform: scale(1.02);
    }

    .history-item:active {
        transform: scale(0.98);
    }

    .history-item-image {
        width: 64px;
        height: 64px;
        border-radius: var(--radius-sm);
        object-fit: cover;
        background: var(--bg-secondary);
        margin-bottom: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }

    .history-item-placeholder {
        width: 64px;
        height: 64px;
        border-radius: var(--radius-sm);
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-card-hover) 100%);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
    }

    .history-item-placeholder svg {
        width: 24px;
        height: 24px;
    }

    .history-item-title {
        font-size: 0.75rem;
        font-weight: 500;
        text-align: center;
        color: var(--text-primary);
        line-height: 1.3;
        max-width: 100%;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .history-item-subtitle {
        font-size: 0.65rem;
        color: var(--text-muted);
        text-align: center;
        margin-top: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }

    /* Type indicators */
    .history-item[data-type="tunein"] .history-item-placeholder {
        background: linear-gradient(135deg, rgba(249, 115, 22, 0.15) 0%, rgba(249, 115, 22, 0.05) 100%);
        color: #f97316;
    }

    .history-item[data-type="radioparadise"] .history-item-placeholder {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(16, 185, 129, 0.05) 100%);
        color: #10b981;
    }

    .history-item[data-type="qobuz"] .history-item-placeholder {
        background: linear-gradient(135deg, rgba(29, 185, 84, 0.15) 0%, rgba(29, 185, 84, 0.05) 100%);
        color: var(--accent-primary);
    }

    /* Players Link */
    .players-link {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 12px 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.85rem;
        transition: all 0.15s ease;
    }

    .players-link:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .players-link svg {
        width: 18px;
        height: 18px;
    }

    /* Desktop - show descriptions, slightly larger cards */
    @@media (min-width: 481px) {
        .source-grid {
            gap: 12px;
        }

        .source-card {
            padding: 16px 12px;
            gap: 8px;
        }

        .source-icon {
            width: 48px;
            height: 48px;
        }

        .source-icon svg {
            width: 26px;
            height: 26px;
        }

        .source-name {
            font-size: 0.85rem;
        }

        .source-desc {
            display: block;
            font-size: 0.7rem;
        }

        .history-grid {
            grid-template-columns: repeat(5, 1fr);
        }
    }

    /* Mobile specific */
    @@media (max-width: 480px) {
        .index-title {
            font-size: 1.5rem;
        }

        .source-icon {
            width: 36px;
            height: 36px;
        }

        .source-icon svg {
            width: 20px;
            height: 20px;
        }

        .history-item-image,
        .history-item-placeholder {
            width: 56px;
            height: 56px;
        }
    }
</style>

<script>
(function() {
    'use strict';

    // State
    let historyData = null;
    let initialized = false;

    // ==================== Source Selection ====================

    window.selectSource = async function(source) {
        if (source === 'tunein') {
            navigateTo('/TuneIn');
            return;
        }

        if (source === 'radioparadise') {
            navigateTo('/RadioParadise');
            return;
        }

        // For Qobuz: check if a user is already selected
        if (source === 'qobuz') {
            if (typeof UserProfileManager !== 'undefined') {
                const activeProfileId = await UserProfileManager.getActiveProfileId();
                if (activeProfileId) {
                    navigateTo('/Qobuz');
                    return;
                }
            }
            // No user selected, show profile switcher
            showProfileSwitcher();
        }
    };

    // ==================== Play from History ====================

    window.playFromHistory = async function(type, item) {
        const selectedPlayer = window.GlobalPlayer?.getSelectedPlayer();

        if (type === 'tunein') {
            if (selectedPlayer?.ip) {
                try {
                    const response = await fetch('/TuneIn?handler=PlayStation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: JSON.stringify({
                            ip: selectedPlayer.ip,
                            port: selectedPlayer.port || 11000,
                            playUrl: item.actionUrl,
                            title: item.title,
                            imageUrl: item.imageUrl
                        })
                    });
                    const data = await response.json();
                    if (data.success && window.GlobalPlayer) {
                        window.GlobalPlayer.setCurrentTrack({
                            title: item.title,
                            artist: 'TuneIn Radio',
                            imageUrl: item.imageUrl,
                            isLive: true
                        });
                        window.GlobalPlayer.setPlaying(true);
                    }
                } catch (e) {
                    console.error('Failed to play TuneIn station:', e);
                }
            } else {
                navigateTo('/TuneIn');
            }
        } else if (type === 'radioparadise') {
            if (selectedPlayer?.ip) {
                try {
                    const response = await fetch('/RadioParadise?handler=PlayStation', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                        },
                        body: JSON.stringify({
                            ip: selectedPlayer.ip,
                            port: selectedPlayer.port || 11000,
                            playUrl: item.actionUrl,
                            title: item.title,
                            imageUrl: item.imageUrl
                        })
                    });
                    const data = await response.json();
                    if (data.success && window.GlobalPlayer) {
                        window.GlobalPlayer.setCurrentTrack({
                            title: item.title,
                            artist: 'Radio Paradise',
                            imageUrl: item.imageUrl,
                            isLive: true
                        });
                        window.GlobalPlayer.setPlaying(true);
                    }
                } catch (e) {
                    console.error('Failed to play Radio Paradise:', e);
                }
            } else {
                navigateTo('/RadioParadise');
            }
        } else if (type === 'album') {
            navigateTo('/Qobuz?album=' + item.albumId);
        } else if (type === 'playlist') {
            navigateTo('/Qobuz?playlist=' + item.playlistId);
        }
    };

    // ==================== History Functions ====================

    async function loadHistory(retryCount = 0) {
        // Wait for next frame to ensure DOM is ready after SPA navigation
        await new Promise(resolve => requestAnimationFrame(resolve));

        let container = document.getElementById('history-container');

        // Retry if container not found (might be timing issue with SPA navigation)
        if (!container && retryCount < 3) {
            await new Promise(resolve => setTimeout(resolve, 50));
            return loadHistory(retryCount + 1);
        }

        if (!container) {
            console.warn('Index: history-container not found after retries');
            return;
        }

        try {
            const response = await fetch('/?handler=History');
            if (!response.ok) {
                console.error('Failed to fetch history:', response.status);
                return;
            }
            const data = await response.json();

            if (data.success) {
                historyData = data;
                // Re-get container in case DOM changed
                container = document.getElementById('history-container');
                if (container) {
                    renderHistory();
                }
            }
        } catch (error) {
            console.error('Failed to load history:', error);
        }
    }

    function renderHistory() {
        const container = document.getElementById('history-container');
        if (!container || !historyData) return;

        const hasTuneIn = historyData.tuneIn && historyData.tuneIn.length > 0;
        const hasRadioParadise = historyData.radioParadise && historyData.radioParadise.length > 0;
        const hasAlbums = historyData.qobuzAlbums && historyData.qobuzAlbums.length > 0;
        const hasPlaylists = historyData.qobuzPlaylists && historyData.qobuzPlaylists.length > 0;

        if (!hasTuneIn && !hasRadioParadise && !hasAlbums && !hasPlaylists) {
            container.innerHTML = '';
            return;
        }

        let html = '';

        // Order: Playlists, Albums, TuneIn, Radio Paradise
        if (hasPlaylists) {
            html += renderHistorySection('Zuletzt gehort - Playlists', 'qobuz', historyData.qobuzPlaylists.map(item => ({
                id: item.id,
                playlistId: item.playlistId,
                title: item.playlistName,
                imageUrl: item.coverUrl,
                type: 'playlist'
            })));
        }

        if (hasAlbums) {
            html += renderHistorySection('Zuletzt gehort - Alben', 'qobuz', historyData.qobuzAlbums.map(item => ({
                id: item.id,
                albumId: item.albumId,
                title: item.albumName,
                subtitle: item.artist,
                imageUrl: item.coverUrl,
                type: 'album'
            })));
        }

        if (hasTuneIn) {
            html += renderHistorySection('Zuletzt gehort - Radio', 'tunein', historyData.tuneIn.map(item => ({
                ...item,
                type: 'tunein'
            })));
        }

        if (hasRadioParadise) {
            html += renderHistorySection('Zuletzt gehort - Radio Paradise', 'radioparadise', historyData.radioParadise.map(item => ({
                ...item,
                type: 'radioparadise',
                subtitle: item.quality
            })));
        }

        container.innerHTML = html;
    }

    function renderHistorySection(title, iconType, items) {
        const placeholderIcon = getPlaceholderIcon(iconType);

        return `
            <section class="history-section">
                <h3 class="history-title">${title}</h3>
                <div class="history-grid">
                    ${items.map(item => `
                        <a href="#" class="history-item" data-type="${iconType}" onclick="playFromHistory('${item.type}', ${escapeJsonForHtml(item)}); return false;">
                            ${item.imageUrl
                                ? `<img class="history-item-image" src="${escapeHtml(item.imageUrl)}" alt="" loading="lazy" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'"><div class="history-item-placeholder" style="display:none">${placeholderIcon}</div>`
                                : `<div class="history-item-placeholder">${placeholderIcon}</div>`
                            }
                            <span class="history-item-title">${escapeHtml(item.title)}</span>
                            ${item.subtitle ? `<span class="history-item-subtitle">${escapeHtml(item.subtitle)}</span>` : ''}
                        </a>
                    `).join('')}
                </div>
            </section>
        `;
    }

    function getPlaceholderIcon(type) {
        if (type === 'tunein') {
            return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 018 0"/><circle cx="12" cy="12" r="1" fill="currentColor"/></svg>';
        } else if (type === 'radioparadise') {
            return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 3L2 9l10 6 10-6-10-6z"/><path d="M2 17l10 6 10-6"/><path d="M2 13l10 6 10-6"/></svg>';
        } else {
            return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M9 18V5l12-2v13"/><circle cx="6" cy="18" r="3"/><circle cx="18" cy="16" r="3"/></svg>';
        }
    }

    function escapeJsonForHtml(obj) {
        return JSON.stringify(obj).replace(/'/g, "\\'").replace(/"/g, '&quot;');
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ==================== Initialization ====================

    async function initIndexPage() {
        // Reset state for fresh init
        historyData = null;
        initialized = true;

        // Update profile display in menu
        if (typeof updateProfileDisplay === 'function') {
            try {
                await updateProfileDisplay();
            } catch (e) {
                console.warn('Failed to update profile display:', e);
            }
        }

        // Load listening history
        await loadHistory();
    }

    // Expose init function globally for SPA router
    window.initIndexPage = initIndexPage;

    // Initialize immediately - the script runs after DOM is inserted
    initIndexPage();
})();
</script>
