@model BluesoundWeb.Pages.QobuzModel

<div class="qobuz-app">
    <!-- Header -->
    <header class="app-header">
        <div class="header-content">
            <div class="header-left">
                <button type="button" class="hamburger-btn" onclick="toggleMenu()" aria-label="Menu">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="3" y1="6" x2="21" y2="6"/>
                        <line x1="3" y1="12" x2="21" y2="12"/>
                        <line x1="3" y1="18" x2="21" y2="18"/>
                    </svg>
                </button>
                <div class="brand">
                    <svg class="brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <h1>Qobuz</h1>
                </div>
            </div>
            <div class="header-actions">
                <div id="user-menu" class="user-menu" style="display: none;">
                    <button type="button" class="btn-logout" onclick="logout()" title="Abmelden">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                    </button>
                </div>
                <div class="profile-indicator" onclick="toggleMenu()">
                    <span id="header-profile-initial" class="profile-initial">?</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Hamburger Menu Overlay -->
    <div id="menu-overlay" class="menu-overlay" onclick="closeMenu()"></div>

    <!-- Hamburger Menu Panel -->
    <nav id="menu-panel" class="menu-panel">
        <div class="menu-header">
            <div class="menu-profile" onclick="showProfileSwitcher()">
                <div class="menu-profile-avatar" id="menu-profile-avatar">?</div>
                <div class="menu-profile-info">
                    <span class="menu-profile-name" id="menu-profile-name">Profil</span>
                    <span class="menu-profile-switch">Profil wechseln</span>
                </div>
                <svg class="menu-profile-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6"/>
                </svg>
            </div>
        </div>
        <div class="menu-items">
            <a href="/Qobuz" class="menu-item active" onclick="navigateTo('/Qobuz'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <span>Qobuz</span>
            </a>
            <a href="/Players" class="menu-item" onclick="navigateTo('/Players'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 9v-2M12 17v-2M9 12H7M17 12h-2"/>
                </svg>
                <span>Players</span>
            </a>
        </div>
        <div class="menu-footer">
            <a href="/" class="menu-item menu-item-home" onclick="navigateTo('/'); return false;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <span>Quellen</span>
            </a>
        </div>
    </nav>

    <!-- Profile Switcher Modal -->
    <div id="profile-switcher-overlay" class="profile-switcher-overlay" onclick="closeProfileSwitcher(event)">
        <div class="profile-switcher-modal" onclick="event.stopPropagation()">
            <div class="profile-switcher-header">
                <h3>Profil wechseln</h3>
                <button type="button" class="btn-close-modal" onclick="closeProfileSwitcher()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="profile-switcher-list" id="profile-switcher-list">
                <!-- Profiles will be rendered here -->
            </div>
            <button type="button" class="btn-add-profile" onclick="createNewProfile()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span>Neues Profil erstellen</span>
            </button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <div class="spinner-ring"></div>
            <span class="loading-text">Laden...</span>
        </div>
    </div>

    <!-- Messages -->
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-error">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="15" y1="9" x2="9" y2="15"/>
                <line x1="9" y1="9" x2="15" y2="15"/>
            </svg>
            <span>@Model.ErrorMessage</span>
        </div>
    }

    <div id="error-message" class="alert alert-error" style="display: none;">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <line x1="15" y1="9" x2="9" y2="15"/>
            <line x1="9" y1="9" x2="15" y2="15"/>
        </svg>
        <span id="error-text"></span>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Login Section -->
        <div id="login-section" class="login-section">
            <div class="login-card">
                <div class="login-header">
                    <svg class="qobuz-logo" viewBox="0 0 100 100" fill="currentColor">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="6"/>
                        <circle cx="50" cy="50" r="20"/>
                    </svg>
                    <h2>Bei Qobuz anmelden</h2>
                    <p>Melde dich an, um deine Playlists zu sehen</p>
                </div>
                <form id="login-form" class="login-form">
                    @Html.AntiForgeryToken()
                    <div class="form-group">
                        <label for="email">E-Mail oder Benutzername</label>
                        <input type="text" id="email" name="email" required autocomplete="username"
                               placeholder="name@example.com">
                    </div>
                    <div class="form-group">
                        <label for="password">Passwort</label>
                        <input type="password" id="password" name="password" required autocomplete="current-password"
                               placeholder="Dein Passwort">
                    </div>
                    <button type="submit" class="btn-login">
                        <span>Anmelden</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"/>
                        </svg>
                    </button>
                </form>
            </div>
        </div>

        <!-- Logged In Section -->
        <div id="logged-in-section" class="logged-in-section" style="display: none;">
            <!-- Search Box -->
            <div class="search-container">
                <div class="search-input-wrapper">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <input type="text" id="search-input" class="search-input" placeholder="Alben, Playlists, Titel suchen..." autocomplete="off">
                    <button type="button" id="search-clear" class="search-clear" style="display: none;" onclick="clearSearch()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Search Results (hidden by default) -->
            <div id="search-results" class="search-results" style="display: none;">
                <div class="search-results-header">
                    <h2>Suchergebnisse</h2>
                    <button type="button" class="btn-back-search" onclick="clearSearch()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                        <span>Schliessen</span>
                    </button>
                </div>

                <!-- Albums Section -->
                <div id="search-albums-section" class="search-section" style="display: none;">
                    <h3 class="search-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="3"/>
                        </svg>
                        Alben & Singles
                    </h3>
                    <div id="search-albums-grid" class="search-grid"></div>
                </div>

                <!-- Playlists Section -->
                <div id="search-playlists-section" class="search-section" style="display: none;">
                    <h3 class="search-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18V5l12-2v13"/>
                            <circle cx="6" cy="18" r="3"/>
                            <circle cx="18" cy="16" r="3"/>
                        </svg>
                        Playlists
                    </h3>
                    <div id="search-playlists-grid" class="search-grid"></div>
                </div>

                <!-- Tracks Section -->
                <div id="search-tracks-section" class="search-section" style="display: none;">
                    <h3 class="search-section-title">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 18V5l12-2v13"/>
                            <circle cx="6" cy="18" r="3"/>
                            <circle cx="18" cy="16" r="3"/>
                        </svg>
                        Titel
                    </h3>
                    <div id="search-tracks-list" class="search-tracks-list"></div>
                </div>

                <!-- No Results -->
                <div id="search-no-results" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="M21 21l-4.35-4.35"/>
                    </svg>
                    <h3>Keine Ergebnisse</h3>
                    <p>Versuche einen anderen Suchbegriff.</p>
                </div>
            </div>

            <!-- Content Tabs (hidden when searching) -->
            <div id="browse-content">
            <div class="content-tabs">
                <button type="button" class="tab-btn active" data-tab="my-playlists" onclick="switchTab('my-playlists')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18V5l12-2v13"/>
                        <circle cx="6" cy="18" r="3"/>
                        <circle cx="18" cy="16" r="3"/>
                    </svg>
                    <span>Meine Playlists</span>
                </button>
                <button type="button" class="tab-btn" data-tab="new-releases" onclick="switchTab('new-releases')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 2v4M12 18v4"/>
                    </svg>
                    <span>Neuheiten</span>
                </button>
                <button type="button" class="tab-btn" data-tab="top-playlists" onclick="switchTab('top-playlists')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    <span>Top Playlists</span>
                </button>
                <button type="button" class="tab-btn" data-tab="recommendations" onclick="switchTab('recommendations')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <span>Favoriten</span>
                </button>
            </div>

            <!-- Tab Content: My Playlists -->
            <div id="tab-my-playlists" class="tab-content active">
                <div class="section-header">
                    <h2>Deine Playlists</h2>
                    <button type="button" class="btn-refresh" onclick="loadPlaylists()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>

                <div id="playlists-grid" class="playlists-grid">
                    <!-- Playlists will be loaded here -->
                </div>

                <div id="playlists-empty" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M9 18V5l12-2v13"/>
                        <circle cx="6" cy="18" r="3"/>
                        <circle cx="18" cy="16" r="3"/>
                    </svg>
                    <h3>Keine Playlists</h3>
                    <p>Du hast noch keine Playlists erstellt.</p>
                </div>
            </div>

            <!-- Tab Content: New Releases -->
            <div id="tab-new-releases" class="tab-content">
                <div class="section-header">
                    <h2>Neuheiten</h2>
                    <button type="button" class="btn-refresh" onclick="loadNewReleases()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>

                <div id="albums-grid" class="playlists-grid">
                    <!-- Albums will be loaded here -->
                </div>

                <div id="albums-empty" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="3"/>
                    </svg>
                    <h3>Keine Neuheiten</h3>
                    <p>Momentan keine neuen Alben verfügbar.</p>
                </div>
            </div>

            <!-- Tab Content: Top Playlists -->
            <div id="tab-top-playlists" class="tab-content">
                <div class="section-header">
                    <h2>Top Playlists</h2>
                    <button type="button" class="btn-refresh" onclick="loadTopPlaylists()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>

                <div id="top-playlists-grid" class="playlists-grid">
                    <!-- Top playlists will be loaded here -->
                </div>

                <div id="top-playlists-empty" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                    </svg>
                    <h3>Keine Top Playlists</h3>
                    <p>Momentan keine Top Playlists verfügbar.</p>
                </div>
            </div>

            <!-- Tab Content: Favorites -->
            <div id="tab-recommendations" class="tab-content">
                <div class="section-header">
                    <h2>Deine Favoriten</h2>
                    <button type="button" class="btn-refresh" onclick="loadRecommendations()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
                        </svg>
                    </button>
                </div>

                <div id="recommendations-content">
                    <!-- Favorite albums section -->
                    <div id="recommendations-albums-section" style="display: none;">
                        <h3 class="subsection-title">Alben</h3>
                        <div id="recommendations-albums-grid" class="playlists-grid">
                            <!-- Favorite albums will be loaded here -->
                        </div>
                    </div>

                    <!-- Favorite playlists section -->
                    <div id="recommendations-playlists-section" style="display: none;">
                        <h3 class="subsection-title">Playlists</h3>
                        <div id="recommendations-playlists-grid" class="playlists-grid">
                            <!-- Favorite playlists will be loaded here -->
                        </div>
                    </div>

                    <!-- Favorite tracks section -->
                    <div id="recommendations-tracks-section" style="display: none;">
                        <h3 class="subsection-title">Titel</h3>
                        <div id="recommendations-tracks-grid" class="playlists-grid">
                            <!-- Favorite tracks will be loaded here -->
                        </div>
                    </div>
                </div>

                <div id="recommendations-empty" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                    </svg>
                    <h3>Keine Favoriten</h3>
                    <p>Füge Alben und Titel zu deinen Favoriten hinzu.</p>
                </div>
            </div>

            </div><!-- end browse-content -->
        </div>

        <!-- Playlist Detail Section -->
        <div id="playlist-detail-section" class="playlist-detail-section" style="display: none;">
            <div class="playlist-detail-header">
                <button type="button" class="btn-back" onclick="backToPlaylists()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    <span>Zurück</span>
                </button>
            </div>

            <div class="playlist-detail-info">
                <div class="playlist-detail-cover">
                    <img id="detail-cover" src="" alt="Cover">
                    <div class="playlist-cover-placeholder" id="detail-cover-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 18V5l12-2v13"/>
                            <circle cx="6" cy="18" r="3"/>
                            <circle cx="18" cy="16" r="3"/>
                        </svg>
                    </div>
                </div>
                <div class="playlist-detail-meta">
                    <h2 id="detail-name"></h2>
                    <p id="detail-description" class="detail-description"></p>
                    <div class="detail-stats">
                        <span id="detail-tracks-count"></span>
                        <span class="divider">·</span>
                        <span id="detail-duration"></span>
                    </div>
                    <button type="button" class="btn-play-all" onclick="playAll()">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                        <span>Alle abspielen</span>
                    </button>
                </div>
            </div>

            <div class="tracks-list" id="tracks-list">
                <!-- Tracks will be loaded here -->
            </div>
        </div>

    </main>

</div>

<style>
    /* CSS Variables - same as main app */
    :root {
        --bg-primary: #0a0a0b;
        --bg-secondary: #111113;
        --bg-card: #161618;
        --bg-card-hover: #1c1c1f;
        --border-subtle: rgba(255, 255, 255, 0.06);
        --border-accent: rgba(255, 255, 255, 0.1);
        --text-primary: #f4f4f5;
        --text-secondary: #a1a1aa;
        --text-muted: #71717a;
        --accent-qobuz: #1db954;
        --accent-blue: #3b82f6;
        --danger: #ef4444;
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 14px;
        --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
        --transition: 0.15s ease;
    }

    /* Base */
    .qobuz-app {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        background: var(--bg-primary);
        min-height: 100vh;
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .app-header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-subtle);
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 0 max(16px, env(safe-area-inset-left));
        padding-top: env(safe-area-inset-top);
    }

    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        max-width: 1200px;
        margin: 0 auto;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .hamburger-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        cursor: pointer;
        border-radius: var(--radius-sm);
        transition: all var(--transition);
    }

    .hamburger-btn:hover {
        background: var(--bg-card);
        color: var(--text-primary);
    }

    .hamburger-btn svg {
        width: 22px;
        height: 22px;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .profile-indicator {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: var(--accent-qobuz);
        border-radius: 50%;
        cursor: pointer;
        transition: all var(--transition);
    }

    .profile-indicator:hover {
        transform: scale(1.05);
    }

    .profile-initial {
        font-size: 0.9rem;
        font-weight: 600;
        color: white;
        text-transform: uppercase;
    }

    .brand {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .brand-icon {
        width: 28px;
        height: 28px;
        color: var(--accent-qobuz);
    }

    .brand h1 {
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        margin: 0;
    }

    .user-menu {
        display: flex;
        gap: 8px;
    }

    .btn-logout {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: transparent;
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-sm);
        color: var(--text-muted);
        cursor: pointer;
        transition: all var(--transition);
    }

    .btn-logout:hover {
        background: rgba(239, 68, 68, 0.1);
        border-color: var(--danger);
        color: var(--danger);
    }

    .btn-logout svg {
        width: 18px;
        height: 18px;
    }

    /* Loading Overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 10, 11, 0.85);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }

    .loading-overlay.active {
        display: flex;
    }

    .loading-spinner {
        position: relative;
        width: 50px;
        height: 50px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .spinner-ring {
        position: absolute;
        border-radius: 50%;
        border: 2px solid transparent;
        animation: spin 1.2s linear infinite;
    }

    .spinner-ring:nth-child(1) {
        width: 50px;
        height: 50px;
        border-top-color: var(--accent-qobuz);
    }

    .spinner-ring:nth-child(2) {
        width: 38px;
        height: 38px;
        border-right-color: var(--accent-blue);
        animation-direction: reverse;
    }

    .spinner-ring:nth-child(3) {
        width: 26px;
        height: 26px;
        border-bottom-color: var(--text-primary);
    }

    .loading-text {
        position: absolute;
        top: 70px;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Alerts */
    .alert {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        margin: 16px;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        max-width: 1200px;
        margin-left: auto;
        margin-right: auto;
    }

    .alert svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    .alert-error {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.2);
        color: #fca5a5;
    }

    /* Main Content */
    .main-content {
        padding: 20px max(16px, env(safe-area-inset-left));
        padding-bottom: calc(100px + max(20px, env(safe-area-inset-bottom)));
        max-width: 1200px;
        margin: 0 auto;
    }

    /* Login Section */
    .login-section {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: calc(100vh - 200px);
    }

    .login-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 32px;
        width: 100%;
        max-width: 400px;
        box-shadow: var(--shadow-card);
    }

    .login-header {
        text-align: center;
        margin-bottom: 24px;
    }

    .qobuz-logo {
        width: 64px;
        height: 64px;
        color: var(--accent-qobuz);
        margin-bottom: 16px;
    }

    .login-header h2 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 8px;
    }

    .login-header p {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0;
    }

    .login-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .form-group label {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--text-secondary);
    }

    .form-group input {
        padding: 12px 14px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.95rem;
        transition: all var(--transition);
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--accent-qobuz);
        box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
    }

    .form-group input::placeholder {
        color: var(--text-muted);
    }

    .btn-login {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 14px;
        background: var(--accent-qobuz);
        border: none;
        border-radius: var(--radius-md);
        color: white;
        font-size: 0.95rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition);
        margin-top: 8px;
    }

    .btn-login:hover {
        background: #1ed760;
        transform: translateY(-1px);
    }

    .btn-login:active {
        transform: translateY(0);
    }

    .btn-login svg {
        width: 18px;
        height: 18px;
    }

    /* Logged In Section */
    .logged-in-section {
        animation: fadeIn 0.3s ease;
    }

    @@keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Search */
    .search-container {
        margin-bottom: 20px;
    }

    .search-input-wrapper {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-icon {
        position: absolute;
        left: 14px;
        width: 20px;
        height: 20px;
        color: var(--text-muted);
        pointer-events: none;
    }

    .search-input {
        width: 100%;
        padding: 14px 44px;
        background: var(--bg-card);
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 0.95rem;
        outline: none;
        transition: all var(--transition);
    }

    .search-input::placeholder {
        color: var(--text-muted);
    }

    .search-input:focus {
        border-color: var(--accent-qobuz);
        box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
    }

    .search-clear {
        position: absolute;
        right: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: 50%;
        transition: all var(--transition);
    }

    .search-clear:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
    }

    .search-clear svg {
        width: 16px;
        height: 16px;
    }

    /* Search Results */
    .search-results {
        animation: fadeIn 0.2s ease;
    }

    .search-results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .search-results-header h2 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }

    .btn-back-search {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: transparent;
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        font-size: 0.8rem;
        cursor: pointer;
        transition: all var(--transition);
    }

    .btn-back-search:hover {
        background: var(--bg-card);
        color: var(--text-primary);
    }

    .btn-back-search svg {
        width: 16px;
        height: 16px;
    }

    .search-section {
        margin-bottom: 28px;
    }

    .search-section-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-secondary);
        margin: 0 0 14px 0;
        text-transform: uppercase;
        letter-spacing: 0.03em;
    }

    .search-section-title svg {
        width: 18px;
        height: 18px;
        color: var(--accent-qobuz);
    }

    .search-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 14px;
    }

    /* Search Result Card */
    .search-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        overflow: hidden;
        cursor: pointer;
        transition: all var(--transition);
    }

    .search-card:hover {
        transform: translateY(-2px);
        border-color: var(--border-accent);
        box-shadow: var(--shadow-card);
    }

    .search-card-cover {
        position: relative;
        aspect-ratio: 1;
        background: var(--bg-secondary);
    }

    .search-card-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .search-card-type {
        position: absolute;
        top: 8px;
        left: 8px;
        padding: 4px 8px;
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: white;
    }

    .search-card-type.album {
        background: rgba(59, 130, 246, 0.9);
    }

    .search-card-type.single {
        background: rgba(168, 85, 247, 0.9);
    }

    .search-card-type.ep {
        background: rgba(236, 72, 153, 0.9);
    }

    .search-card-type.playlist {
        background: rgba(29, 185, 84, 0.9);
    }

    .search-card-info {
        padding: 12px;
    }

    .search-card-title {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0 0 4px 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .search-card-subtitle {
        font-size: 0.75rem;
        color: var(--text-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Search Tracks List */
    .search-tracks-list {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .search-track-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: var(--bg-card);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition);
    }

    .search-track-item:hover {
        background: var(--bg-card-hover);
    }

    .search-track-cover {
        width: 44px;
        height: 44px;
        border-radius: 4px;
        overflow: hidden;
        flex-shrink: 0;
        background: var(--bg-secondary);
    }

    .search-track-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .search-track-info {
        flex: 1;
        min-width: 0;
    }

    .search-track-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-primary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .search-track-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .search-track-duration {
        font-size: 0.8rem;
        color: var(--text-muted);
        flex-shrink: 0;
    }

    .search-track-badge {
        padding: 2px 6px;
        background: rgba(29, 185, 84, 0.2);
        border-radius: 4px;
        font-size: 0.65rem;
        font-weight: 600;
        color: var(--accent-qobuz);
        flex-shrink: 0;
    }

    /* Search Skeleton */
    .search-skeleton {
        animation: fadeIn 0.15s ease;
    }

    .skeleton-section {
        margin-bottom: 24px;
    }

    .skeleton-title {
        width: 120px;
        height: 16px;
        background: var(--bg-card);
        border-radius: 4px;
        margin-bottom: 14px;
        animation: skeleton-pulse 1.5s ease-in-out infinite;
    }

    .skeleton-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 14px;
    }

    .skeleton-card {
        background: var(--bg-card);
        border-radius: var(--radius-md);
        overflow: hidden;
    }

    .skeleton-cover {
        aspect-ratio: 1;
        background: var(--bg-secondary);
        animation: skeleton-pulse 1.5s ease-in-out infinite;
    }

    .skeleton-text {
        height: 14px;
        background: var(--bg-secondary);
        border-radius: 4px;
        margin: 12px;
        animation: skeleton-pulse 1.5s ease-in-out infinite;
    }

    .skeleton-text.short {
        width: 60%;
        height: 12px;
        margin-top: 8px;
    }

    .skeleton-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .skeleton-track {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px 12px;
        background: var(--bg-card);
        border-radius: var(--radius-sm);
    }

    .skeleton-track-cover {
        width: 44px;
        height: 44px;
        background: var(--bg-secondary);
        border-radius: 4px;
        flex-shrink: 0;
        animation: skeleton-pulse 1.5s ease-in-out infinite;
    }

    .skeleton-track-info {
        flex: 1;
    }

    .skeleton-track-info .skeleton-text {
        margin: 0 0 6px 0;
        width: 70%;
    }

    .skeleton-track-info .skeleton-text.short {
        margin: 0;
        width: 50%;
    }

    @@keyframes skeleton-pulse {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.5;
        }
    }

    /* Content Tabs */
    .content-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-subtle);
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }

    .content-tabs::-webkit-scrollbar {
        display: none;
    }

    .tab-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: transparent;
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition);
        white-space: nowrap;
        flex-shrink: 0;
    }

    .tab-btn:hover {
        background: var(--bg-card);
        color: var(--text-primary);
        border-color: var(--border-accent);
    }

    .tab-btn.active {
        background: var(--accent-qobuz);
        border-color: var(--accent-qobuz);
        color: white;
    }

    .tab-btn svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
    }

    /* Tab Content */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* Section Header (replaces playlists-header) */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .section-header h2 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }

    /* Subsection titles for recommendations */
    .subsection-title {
        font-size: 1rem;
        font-weight: 600;
        margin: 24px 0 12px 0;
        color: var(--text-primary);
    }

    .subsection-title:first-child {
        margin-top: 0;
    }

    /* Track card extras */
    .track-extra {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 4px;
    }

    .track-duration {
        font-size: 0.75rem;
        color: var(--text-tertiary);
    }

    /* Playlists (kept for backward compatibility) */
    .playlists-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .playlists-header h2 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
    }

    .btn-refresh {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: var(--bg-card);
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-sm);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all var(--transition);
    }

    .btn-refresh:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
    }

    .btn-refresh svg {
        width: 18px;
        height: 18px;
    }

    .playlists-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 16px;
    }

    .playlist-card {
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        overflow: hidden;
        transition: all var(--transition);
        cursor: pointer;
    }

    .playlist-card:hover {
        border-color: var(--border-accent);
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    }

    .playlist-cover {
        position: relative;
        aspect-ratio: 1;
        background: var(--bg-secondary);
    }

    .playlist-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .playlist-cover-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--text-muted);
    }

    .playlist-cover-placeholder svg {
        width: 48px;
        height: 48px;
        opacity: 0.5;
    }

    .playlist-info {
        padding: 12px;
    }

    .playlist-name {
        font-size: 0.9rem;
        font-weight: 600;
        margin: 0 0 4px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .playlist-meta {
        font-size: 0.75rem;
        color: var(--text-muted);
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-secondary);
    }

    .empty-state svg {
        width: 64px;
        height: 64px;
        margin-bottom: 16px;
        opacity: 0.4;
    }

    .empty-state h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 8px;
        color: var(--text-primary);
    }

    .empty-state p {
        font-size: 0.875rem;
        margin: 0;
    }

    /* Playlist Detail Section */
    .playlist-detail-section {
        animation: fadeIn 0.3s ease;
    }

    .playlist-detail-header {
        margin-bottom: 20px;
    }

    .btn-back {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: var(--bg-card);
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all var(--transition);
    }

    .btn-back:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
    }

    .btn-back svg {
        width: 18px;
        height: 18px;
    }

    .playlist-detail-info {
        display: flex;
        gap: 24px;
        margin-bottom: 24px;
        padding: 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
    }

    .playlist-detail-cover {
        position: relative;
        width: 160px;
        height: 160px;
        flex-shrink: 0;
        border-radius: var(--radius-md);
        overflow: hidden;
        background: var(--bg-secondary);
    }

    .playlist-detail-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .playlist-detail-meta {
        display: flex;
        flex-direction: column;
        justify-content: center;
        gap: 8px;
        min-width: 0;
    }

    .playlist-detail-meta h2 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0;
        line-height: 1.2;
    }

    .detail-description {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin: 0;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .detail-stats {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    .detail-stats .divider {
        margin: 0 6px;
    }

    .btn-play-all {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: var(--accent-qobuz);
        border: none;
        border-radius: 50px;
        color: white;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition);
        margin-top: 8px;
        width: fit-content;
    }

    .btn-play-all:hover {
        background: #1ed760;
        transform: scale(1.02);
    }

    .btn-play-all svg {
        width: 20px;
        height: 20px;
    }

    /* Tracks List */
    .tracks-list {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .track-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--bg-card);
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all var(--transition);
    }

    .track-item:hover {
        background: var(--bg-card-hover);
    }

    .track-item.playing {
        background: rgba(29, 185, 84, 0.1);
    }

    .track-number {
        width: 24px;
        font-size: 0.8rem;
        color: var(--text-muted);
        text-align: center;
        flex-shrink: 0;
    }

    .track-item:hover .track-number,
    .track-item.playing .track-number {
        display: none;
    }

    .track-play-btn {
        display: none;
        width: 24px;
        height: 24px;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        color: var(--accent-qobuz);
        cursor: pointer;
        flex-shrink: 0;
    }

    .track-item:hover .track-play-btn,
    .track-item.playing .track-play-btn {
        display: flex;
    }

    .track-play-btn svg {
        width: 20px;
        height: 20px;
    }

    .track-cover {
        width: 44px;
        height: 44px;
        border-radius: 4px;
        background: var(--bg-secondary);
        flex-shrink: 0;
        overflow: hidden;
    }

    .track-cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .track-info {
        flex: 1;
        min-width: 0;
    }

    .track-title {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-primary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .track-item.playing .track-title {
        color: var(--accent-qobuz);
    }

    .track-artist {
        font-size: 0.8rem;
        color: var(--text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .track-quality {
        font-size: 0.65rem;
        padding: 2px 6px;
        background: rgba(29, 185, 84, 0.15);
        color: var(--accent-qobuz);
        border-radius: 4px;
        font-weight: 600;
        flex-shrink: 0;
    }

    .track-duration {
        font-size: 0.8rem;
        color: var(--text-muted);
        flex-shrink: 0;
        margin-left: 8px;
    }

    /* Mobile */
    @@media (max-width: 480px) {
        .login-card {
            padding: 24px;
        }

        .playlists-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .playlist-detail-info {
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 16px;
        }

        .playlist-detail-cover {
            width: 140px;
            height: 140px;
        }

        .playlist-detail-meta {
            align-items: center;
        }

        .playlist-detail-meta h2 {
            font-size: 1.25rem;
        }

        .track-item {
            padding: 10px 12px;
        }

        .track-cover {
            width: 40px;
            height: 40px;
        }

        .track-quality {
            display: none;
        }
    }

    /* Light mode */
    @@media (prefers-color-scheme: light) {
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f8f9fa;
            --border-subtle: rgba(0, 0, 0, 0.06);
            --border-accent: rgba(0, 0, 0, 0.1);
            --text-primary: #18181b;
            --text-secondary: #52525b;
            --text-muted: #a1a1aa;
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .loading-overlay {
            background: rgba(248, 249, 250, 0.9);
        }
    }
</style>

<!-- user-profiles.js and hamburger-menu.js are loaded in _Layout.cshtml -->
<script>
    // Global player selection storage key (not per-profile)
    const STORAGE_SELECTED_PLAYER = 'qobuz_selected_player';

    // DOM elements - will be re-fetched in initQobuz for SPA compatibility
    let loadingOverlay = null;
    let loginSection = null;
    let loggedInSection = null;
    let playlistDetailSection = null;
    let userMenu = null;
    let errorMessage = null;
    let errorText = null;

    // Function to refresh DOM element references (needed after SPA navigation)
    function refreshDOMElements() {
        loadingOverlay = document.getElementById('loading-overlay');
        loginSection = document.getElementById('login-section');
        loggedInSection = document.getElementById('logged-in-section');
        playlistDetailSection = document.getElementById('playlist-detail-section');
        userMenu = document.getElementById('user-menu');
        errorMessage = document.getElementById('error-message');
        errorText = document.getElementById('error-text');
    }

    // Playback state
    let currentTracks = [];
    let currentTrackIndex = -1;
    let audioPlayer = null;
    let isPlaying = false;

    // Queue source tracking
    let currentSourceType = null; // 'album' or 'playlist'
    let currentSourceId = null;
    let currentSourceName = null;

    // Progress animation state
    let progressAnimationFrame = null;
    let lastKnownPosition = 0;
    let lastKnownTotal = 0;
    let lastStatusTime = 0;
    let lastTrackTitle = null;

    // Helper to get selected player from GlobalPlayer
    function getSelectedPlayer() {
        return window.GlobalPlayer?.getSelectedPlayer() || { type: 'browser', name: 'Dieses Gerät' };
    }

    // Helper to get stream quality from GlobalPlayer
    function getStreamQuality() {
        return window.GlobalPlayer?.getStreamQuality() || 27;
    }

    // Get active profile Qobuz credentials
    async function getQobuzCredentials() {
        const activeProfile = await UserProfileManager.getActiveProfile();
        if (!activeProfile) {
            console.log('getQobuzCredentials: No active profile');
            return null;
        }
        if (!activeProfile.qobuz) {
            console.log('getQobuzCredentials: Profile has no Qobuz credentials:', activeProfile.id);
            return null;
        }
        console.log('getQobuzCredentials: Found credentials for profile:', activeProfile.id);
        return activeProfile.qobuz;
    }

    // Save Qobuz credentials to active profile
    async function saveQobuzCredentials(data) {
        const activeProfileId = await UserProfileManager.getActiveProfileId();
        if (!activeProfileId) {
            console.error('Cannot save Qobuz credentials: No active profile ID');
            return false;
        }

        try {
            await UserProfileManager.updateQobuzCredentials(activeProfileId, {
                userId: data.userId,
                authToken: data.authToken,
                displayName: data.displayName || null,
                avatar: data.avatar || null
            });
            console.log('Qobuz credentials saved for profile:', activeProfileId);
            return true;
        } catch (error) {
            console.error('Failed to save Qobuz credentials:', error);
            return false;
        }
    }

    // Clear Qobuz credentials from active profile
    async function clearQobuzCredentials() {
        const activeProfileId = await UserProfileManager.getActiveProfileId();
        if (!activeProfileId) return;

        await UserProfileManager.clearQobuzCredentials(activeProfileId);
    }

    // Save queue to database
    async function saveQueueToDb(currentIndex) {
        if (!currentTracks || currentTracks.length === 0) return;

        const activeProfileId = await UserProfileManager.getActiveProfileId();
        if (!activeProfileId) return;

        const queueData = {
            sourceType: currentSourceType,
            sourceId: currentSourceId,
            sourceName: currentSourceName,
            currentIndex: currentIndex,
            tracks: currentTracks
        };

        try {
            await QueueApi.setQueue(activeProfileId, queueData);

            // Update GlobalPlayer queue
            if (window.GlobalPlayer) {
                window.GlobalPlayer.setQueue(queueData);
            }
        } catch (error) {
            console.error('Failed to save queue:', error);
        }
    }

    // Update queue index in database
    async function updateQueueIndexInDb(currentIndex) {
        const activeProfileId = await UserProfileManager.getActiveProfileId();
        if (!activeProfileId) return;

        try {
            await QueueApi.updateQueueIndex(activeProfileId, currentIndex);

            // Update GlobalPlayer queue index
            if (window.GlobalPlayer) {
                window.GlobalPlayer.updateQueueIndex(currentIndex);
            }
        } catch (error) {
            console.error('Failed to update queue index:', error);
        }
    }

    // Show/hide loading
    function showLoading() {
        loadingOverlay.classList.add('active');
    }

    function hideLoading() {
        loadingOverlay.classList.remove('active');
    }

    // Show error message
    function showError(message) {
        errorText.textContent = message;
        errorMessage.style.display = 'flex';
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }

    // Initialize Qobuz page - can be called on initial load or SPA navigation
    async function initQobuz() {
        console.log('initQobuz: Starting initialization');

        // Refresh DOM element references (needed after SPA navigation)
        refreshDOMElements();

        // Reset setup flags for SPA navigation (DOM elements are new)
        loginFormSetup = false;
        searchSetup = false;

        // Invalidate cache on SPA navigation to ensure fresh profile data
        if (typeof SettingsApi !== 'undefined' && SettingsApi.invalidateCache) {
            SettingsApi.invalidateCache();
        }

        // Initialize profile manager
        if (typeof UserProfileManager !== 'undefined') {
            console.log('initQobuz: Initializing UserProfileManager');
            await UserProfileManager.initialize();
            await updateProfileDisplayQobuz();
        } else {
            console.error('initQobuz: UserProfileManager not defined!');
        }

        // Get credentials from active profile
        console.log('initQobuz: Getting credentials');
        const creds = await getQobuzCredentials();
        const userId = creds?.userId;
        const authToken = creds?.authToken;

        // Use global audio player (persists across page navigation)
        audioPlayer = window.GlobalPlayer?.getAudioPlayer() || new Audio();

        // Remove any existing listeners to prevent duplicates
        audioPlayer.removeEventListener('timeupdate', updateProgress);
        audioPlayer.removeEventListener('ended', playNext);
        audioPlayer.removeEventListener('loadedmetadata', updateTotalTime);

        // Add event listeners for progress updates
        audioPlayer.addEventListener('timeupdate', updateProgress);
        audioPlayer.addEventListener('ended', playNext);
        audioPlayer.addEventListener('loadedmetadata', updateTotalTime);

        // Register playback callbacks with GlobalPlayer
        if (window.GlobalPlayer) {
            window.GlobalPlayer.registerPlaybackCallbacks({
                togglePlayPause: togglePlayPause,
                playPrevious: playPrevious,
                playNext: playNext,
                seek: seekTo,
                onPlayerChange: handlePlayerChange
            });

            // Register queue callback for playing tracks from the popup queue
            window.GlobalPlayer.registerQueueCallback(async (index) => {
                if (index >= 0 && index < currentTracks.length) {
                    await playTrack(index);
                }
            });
        }

        // Setup login form for new DOM elements
        setupLoginForm();

        // Setup search for new DOM elements
        setupSearch();

        if (userId && authToken) {
            console.log('initQobuz: Found credentials, verifying token for user:', userId);
            showLoading();
            try {
                const response = await fetch(`/Qobuz?handler=VerifyToken&userId=${userId}&authToken=${encodeURIComponent(authToken)}`);
                const data = await response.json();

                if (data.success) {
                    console.log('initQobuz: Token verified successfully');
                    // Update stored data in profile
                    await saveQobuzCredentials({
                        userId: data.userId,
                        authToken: data.authToken,
                        displayName: data.displayName,
                        avatar: data.avatar
                    });

                    showLoggedInState(data);
                    await loadPlaylists();
                } else {
                    // Token invalid, clear from profile
                    console.warn('initQobuz: Token verification failed:', data.error);
                    await clearQobuzCredentials();
                    showLoginState();
                }
            } catch (error) {
                console.error('Token verification failed:', error);
                await clearQobuzCredentials();
                showLoginState();
            }
            hideLoading();
        } else {
            // No credentials - show login
            console.log('initQobuz: No credentials found, showing login form');
            showLoginState();
        }
    }

    // Show login state
    function showLoginState() {
        if (loginSection) loginSection.style.display = 'block';
        if (loggedInSection) loggedInSection.style.display = 'none';
        if (userMenu) userMenu.style.display = 'none';
    }

    // Make initQobuz available globally for SPA router
    window.initQobuz = initQobuz;

    // Track if event listeners are already setup
    let loginFormSetup = false;
    let searchSetup = false;

    // Setup login form handler
    function setupLoginForm() {
        if (loginFormSetup) return;
        const loginForm = document.getElementById('login-form');
        if (!loginForm) return;
        loginForm.addEventListener('submit', handleLoginSubmit);
        loginFormSetup = true;
    }

    // Check for existing session on page load
    console.log('Qobuz script loaded, readyState:', document.readyState);
    if (document.readyState === 'loading') {
        console.log('Qobuz: Adding DOMContentLoaded listener');
        document.addEventListener('DOMContentLoaded', initQobuz);
    } else {
        console.log('Qobuz: Calling initQobuz immediately');
        initQobuz();
    }

    // Update profile display in header and menu (Qobuz-specific)
    async function updateProfileDisplayQobuz() {
        const activeProfile = await UserProfileManager.getActiveProfile();
        if (!activeProfile) return;

        const initial = UserProfileManager.getProfileInitial(activeProfile.name);
        const color = UserProfileManager.getProfileColor(activeProfile.id);

        // Update header indicator
        const headerInitial = document.getElementById('header-profile-initial');
        if (headerInitial) {
            headerInitial.textContent = initial;
            headerInitial.parentElement.style.background = color;
        }

        // Update menu profile display
        const menuAvatar = document.getElementById('menu-profile-avatar');
        const menuName = document.getElementById('menu-profile-name');
        if (menuAvatar) {
            menuAvatar.textContent = initial;
            menuAvatar.style.background = color;
        }
        if (menuName) {
            menuName.textContent = activeProfile.name;
        }
    }

    // Login form submission handler
    async function handleLoginSubmit(e) {
        e.preventDefault();

        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        showLoading();

        try {
            const formData = new FormData();
            formData.append('email', email);
            formData.append('password', password);

            const response = await fetch('/Qobuz?handler=Login', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                // Store session data in active profile
                await saveQobuzCredentials({
                    userId: data.userId,
                    authToken: data.authToken,
                    displayName: data.displayName,
                    avatar: data.avatar
                });

                showLoggedInState(data);
                await loadPlaylists();
            } else {
                showError(data.error || 'Login fehlgeschlagen');
            }
        } catch (error) {
            console.error('Login failed:', error);
            showError('Login fehlgeschlagen. Bitte versuche es erneut.');
        }

        hideLoading();
    }

    // Show logged in state
    function showLoggedInState(userData) {
        loginSection.style.display = 'none';
        loggedInSection.style.display = 'block';
        userMenu.style.display = 'flex';
    }

    // Search functionality
    let searchTimeout = null;
    let searchInput = null;
    let searchClear = null;
    let searchResults = null;
    let browseContent = null;

    // Setup search event handlers
    function setupSearch() {
        if (searchSetup) return;

        searchInput = document.getElementById('search-input');
        searchClear = document.getElementById('search-clear');
        searchResults = document.getElementById('search-results');
        browseContent = document.getElementById('browse-content');

        if (searchInput) {
            searchInput.addEventListener('input', handleSearchInput);
            searchInput.addEventListener('keydown', handleSearchKeydown);
            searchSetup = true;
        }
    }

    function handleSearchInput() {
        const query = this.value.trim();
        if (searchClear) searchClear.style.display = query ? 'flex' : 'none';

        // Debounce search
        clearTimeout(searchTimeout);
        if (query.length >= 2) {
            searchTimeout = setTimeout(() => performSearch(query), 300);
        } else if (query.length === 0) {
            hideSearchResults();
        }
    }

    function handleSearchKeydown(e) {
        if (e.key === 'Escape') {
            clearSearch();
        }
    }

    // Perform search
    async function performSearch(query) {
        // Show skeleton loading state (don't block input)
        showSearchSkeleton();

        try {
            const response = await fetch(`/Qobuz?handler=Search&query=${encodeURIComponent(query)}&limit=20`);
            const data = await response.json();

            if (data.success) {
                showSearchResults(data);
            } else {
                hideSearchSkeleton();
                showError(data.error || 'Suche fehlgeschlagen');
            }
        } catch (error) {
            console.error('Search failed:', error);
            hideSearchSkeleton();
            showError('Suche fehlgeschlagen');
        }
    }

    // Show skeleton loading state for search
    function showSearchSkeleton() {
        browseContent.style.display = 'none';
        searchResults.style.display = 'block';

        // Hide all sections except show skeleton
        document.getElementById('search-albums-section').style.display = 'none';
        document.getElementById('search-playlists-section').style.display = 'none';
        document.getElementById('search-tracks-section').style.display = 'none';
        document.getElementById('search-no-results').style.display = 'none';

        // Show skeleton in a temporary container
        let skeletonContainer = document.getElementById('search-skeleton');
        if (!skeletonContainer) {
            skeletonContainer = document.createElement('div');
            skeletonContainer.id = 'search-skeleton';
            skeletonContainer.className = 'search-skeleton';
            searchResults.appendChild(skeletonContainer);
        }

        skeletonContainer.style.display = 'block';
        skeletonContainer.innerHTML = `
            <div class="skeleton-section">
                <div class="skeleton-title"></div>
                <div class="skeleton-grid">
                    ${Array(4).fill('<div class="skeleton-card"><div class="skeleton-cover"></div><div class="skeleton-text"></div><div class="skeleton-text short"></div></div>').join('')}
                </div>
            </div>
            <div class="skeleton-section">
                <div class="skeleton-title"></div>
                <div class="skeleton-list">
                    ${Array(3).fill('<div class="skeleton-track"><div class="skeleton-track-cover"></div><div class="skeleton-track-info"><div class="skeleton-text"></div><div class="skeleton-text short"></div></div></div>').join('')}
                </div>
            </div>
        `;
    }

    // Hide skeleton loading state
    function hideSearchSkeleton() {
        const skeletonContainer = document.getElementById('search-skeleton');
        if (skeletonContainer) {
            skeletonContainer.style.display = 'none';
        }
    }

    // Show search results
    function showSearchResults(data) {
        // Hide skeleton first
        hideSearchSkeleton();

        const hasAlbums = data.albums && data.albums.length > 0;
        const hasPlaylists = data.playlists && data.playlists.length > 0;
        const hasTracks = data.tracks && data.tracks.length > 0;
        const hasAnyResults = hasAlbums || hasPlaylists || hasTracks;

        // Hide browse content, show search results
        browseContent.style.display = 'none';
        searchResults.style.display = 'block';

        // Albums section
        const albumsSection = document.getElementById('search-albums-section');
        const albumsGrid = document.getElementById('search-albums-grid');
        if (hasAlbums) {
            albumsSection.style.display = 'block';
            albumsGrid.innerHTML = data.albums.map(album => `
                <div class="search-card" onclick="selectAlbum('${album.id}')">
                    <div class="search-card-cover">
                        ${album.coverUrl ? `<img src="${album.coverUrl}" alt="" loading="lazy">` : ''}
                        <span class="search-card-type ${album.isSingle ? 'single' : (album.typeLabel === 'EP' ? 'ep' : 'album')}">${album.typeLabel}</span>
                    </div>
                    <div class="search-card-info">
                        <h4 class="search-card-title">${escapeHtml(album.title)}</h4>
                        <p class="search-card-subtitle">${escapeHtml(album.artistName || 'Unbekannt')}</p>
                    </div>
                </div>
            `).join('');
        } else {
            albumsSection.style.display = 'none';
        }

        // Playlists section
        const playlistsSection = document.getElementById('search-playlists-section');
        const playlistsGrid = document.getElementById('search-playlists-grid');
        if (hasPlaylists) {
            playlistsSection.style.display = 'block';
            playlistsGrid.innerHTML = data.playlists.map(playlist => `
                <div class="search-card" onclick="selectPlaylist(${playlist.id})">
                    <div class="search-card-cover">
                        ${playlist.coverUrl ? `<img src="${playlist.coverUrl}" alt="" loading="lazy">` : ''}
                        <span class="search-card-type playlist">Playlist</span>
                    </div>
                    <div class="search-card-info">
                        <h4 class="search-card-title">${escapeHtml(playlist.name)}</h4>
                        <p class="search-card-subtitle">${playlist.tracksCount} Titel</p>
                    </div>
                </div>
            `).join('');
        } else {
            playlistsSection.style.display = 'none';
        }

        // Tracks section
        const tracksSection = document.getElementById('search-tracks-section');
        const tracksList = document.getElementById('search-tracks-list');
        if (hasTracks) {
            tracksSection.style.display = 'block';
            tracksList.innerHTML = data.tracks.map(track => `
                <div class="search-track-item" onclick="playSearchTrack(${track.id}, '${escapeHtml(track.title)}', '${escapeHtml(track.artistName || '')}', '${escapeHtml(track.albumTitle || '')}', '${track.coverUrl || ''}')">
                    <div class="search-track-cover">
                        ${track.coverUrl ? `<img src="${track.coverUrl}" alt="" loading="lazy">` : ''}
                    </div>
                    <div class="search-track-info">
                        <div class="search-track-title">${escapeHtml(track.title)}</div>
                        <div class="search-track-meta">${escapeHtml(track.artistName || 'Unbekannt')} · ${escapeHtml(track.albumTitle || '')}</div>
                    </div>
                    ${track.isHiRes ? '<span class="search-track-badge">Hi-Res</span>' : ''}
                    <span class="search-track-duration">${track.formattedDuration}</span>
                </div>
            `).join('');
        } else {
            tracksSection.style.display = 'none';
        }

        // No results
        document.getElementById('search-no-results').style.display = hasAnyResults ? 'none' : 'block';
    }

    // Hide search results
    function hideSearchResults() {
        searchResults.style.display = 'none';
        browseContent.style.display = 'block';
    }

    // Clear search
    function clearSearch() {
        searchInput.value = '';
        searchClear.style.display = 'none';
        hideSearchResults();
        searchInput.blur();
    }

    // Play a track from search results
    async function playSearchTrack(trackId, title, artistName, albumTitle, coverUrl) {
        const creds = await getQobuzCredentials();
        const authToken = creds?.authToken;

        if (!authToken) {
            showError('Bitte melde dich an, um Titel abzuspielen');
            return;
        }

        // Create a temporary track object for playback
        const track = {
            id: trackId,
            title: title,
            artistName: artistName,
            albumTitle: albumTitle,
            albumCover: coverUrl,
            isStreamable: true
        };

        // Set as current track
        currentTracks = [track];
        currentTrackIndex = 0;

        const selectedPlayer = getSelectedPlayer();

        // Check if we should play on Bluesound or browser
        if (selectedPlayer.type === 'bluesound' && selectedPlayer.ip) {
            await playOnBluesound(track, 0, authToken);
        } else {
            await playOnBrowser(track, 0, authToken);
        }
    }

    // Tab switching
    let currentTab = 'my-playlists';
    let newReleasesLoaded = false;
    let topPlaylistsLoaded = false;
    let recommendationsLoaded = false;

    function switchTab(tabId) {
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.tab === tabId);
        });

        // Update tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.toggle('active', content.id === `tab-${tabId}`);
        });

        currentTab = tabId;

        // Load content if needed
        if (tabId === 'new-releases' && !newReleasesLoaded) {
            loadNewReleases();
        } else if (tabId === 'top-playlists' && !topPlaylistsLoaded) {
            loadTopPlaylists();
        } else if (tabId === 'recommendations' && !recommendationsLoaded) {
            loadRecommendations();
        }
    }

    // Load new releases
    async function loadNewReleases() {
        showLoading();

        try {
            const response = await fetch('?handler=FeaturedAlbums&type=new-releases&limit=50');
            const data = await response.json();

            if (data.success) {
                renderAlbums(data.albums);
                newReleasesLoaded = true;
            } else {
                showError('Neuheiten konnten nicht geladen werden');
            }
        } catch (error) {
            console.error('Failed to load new releases:', error);
            showError('Neuheiten konnten nicht geladen werden');
        }

        hideLoading();
    }

    // Render albums grid
    function renderAlbums(albums) {
        const grid = document.getElementById('albums-grid');
        const emptyState = document.getElementById('albums-empty');

        if (!albums || albums.length === 0) {
            grid.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        grid.innerHTML = albums.map(album => `
            <div class="playlist-card" onclick="selectAlbum('${album.id}')">
                <div class="playlist-cover">
                    ${album.coverUrl
                        ? `<img src="${album.coverUrl}" alt="${escapeHtml(album.title)}" loading="lazy">`
                        : `<div class="playlist-cover-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <circle cx="12" cy="12" r="10"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                           </div>`
                    }
                </div>
                <div class="playlist-info">
                    <h3 class="playlist-name">${escapeHtml(album.title)}</h3>
                    <div class="playlist-meta">${escapeHtml(album.artistName || 'Unbekannt')}</div>
                </div>
            </div>
        `).join('');
    }

    // Select album - load and show tracks
    async function selectAlbum(albumId) {
        const creds = await getQobuzCredentials();
        const authToken = creds?.authToken;
        if (!authToken) {
            showError('Bitte melde dich an, um Alben abzuspielen');
            return;
        }

        showLoading();

        try {
            const response = await fetch(`/Qobuz?handler=AlbumTracks&albumId=${albumId}&authToken=${encodeURIComponent(authToken)}`);
            const data = await response.json();

            if (data.success) {
                showAlbumDetail(data.album, data.tracks);
            } else {
                showError(data.error || 'Album konnte nicht geladen werden');
            }
        } catch (error) {
            console.error('Failed to load album:', error);
            showError('Album konnte nicht geladen werden');
        }

        hideLoading();
    }

    // Show album detail view
    function showAlbumDetail(album, tracks) {
        currentTracks = tracks || [];

        // Set source tracking for queue
        currentSourceType = 'album';
        currentSourceId = album.id ? album.id.toString() : null;
        currentSourceName = album.title;

        // Update header info
        document.getElementById('detail-name').textContent = album.title;
        document.getElementById('detail-description').textContent = album.artistName || '';
        document.getElementById('detail-tracks-count').textContent = `${album.tracksCount} Titel`;

        // Format duration
        const totalSeconds = album.duration || 0;
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const formattedDuration = hours > 0 ? `${hours}:${minutes.toString().padStart(2, '0')} Std.` : `${minutes} Min.`;
        document.getElementById('detail-duration').textContent = formattedDuration;

        // Update cover
        const cover = document.getElementById('detail-cover');
        const placeholder = document.getElementById('detail-cover-placeholder');
        if (album.coverUrl) {
            cover.src = album.coverUrl;
            cover.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            cover.style.display = 'none';
            placeholder.style.display = 'flex';
        }

        // Render tracks
        renderTracks(tracks);

        // Show detail section, hide logged in section
        loggedInSection.style.display = 'none';
        playlistDetailSection.style.display = 'block';

        // Scroll to top
        window.scrollTo(0, 0);
    }

    // Load top playlists
    async function loadTopPlaylists() {
        showLoading();

        try {
            const response = await fetch('?handler=FeaturedPlaylists&limit=50');
            const data = await response.json();

            if (data.success) {
                renderTopPlaylists(data.playlists);
                topPlaylistsLoaded = true;
            } else {
                showError('Top Playlists konnten nicht geladen werden');
            }
        } catch (error) {
            console.error('Failed to load top playlists:', error);
            showError('Top Playlists konnten nicht geladen werden');
        }

        hideLoading();
    }

    // Render top playlists grid
    function renderTopPlaylists(playlists) {
        const grid = document.getElementById('top-playlists-grid');
        const emptyState = document.getElementById('top-playlists-empty');

        if (!playlists || playlists.length === 0) {
            grid.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        grid.innerHTML = playlists.map(playlist => `
            <div class="playlist-card" onclick="selectPlaylist(${playlist.id})">
                <div class="playlist-cover">
                    ${playlist.coverUrl
                        ? `<img src="${playlist.coverUrl}" alt="${escapeHtml(playlist.name)}" loading="lazy">`
                        : `<div class="playlist-cover-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M9 18V5l12-2v13"/>
                                <circle cx="6" cy="18" r="3"/>
                                <circle cx="18" cy="16" r="3"/>
                            </svg>
                           </div>`
                    }
                </div>
                <div class="playlist-info">
                    <h3 class="playlist-name">${escapeHtml(playlist.name)}</h3>
                    <div class="playlist-meta">${playlist.tracksCount} Titel · ${playlist.formattedDuration}</div>
                </div>
            </div>
        `).join('');
    }

    // Load favorites
    async function loadRecommendations() {
        const creds = await getQobuzCredentials();
        const authToken = creds?.authToken;

        if (!authToken) {
            document.getElementById('recommendations-empty').style.display = 'block';
            return;
        }

        showLoading();

        try {
            const response = await fetch(`/Qobuz?handler=Recommendations&authToken=${encodeURIComponent(authToken)}&limit=50`);
            const data = await response.json();

            if (data.success) {
                renderRecommendations(data);
                recommendationsLoaded = true;
            } else {
                showError('Favoriten konnten nicht geladen werden');
            }
        } catch (error) {
            console.error('Failed to load favorites:', error);
            showError('Favoriten konnten nicht geladen werden');
        }

        hideLoading();
    }

    // Render recommendations
    function renderRecommendations(data) {
        const albumsSection = document.getElementById('recommendations-albums-section');
        const albumsGrid = document.getElementById('recommendations-albums-grid');
        const playlistsSection = document.getElementById('recommendations-playlists-section');
        const playlistsGrid = document.getElementById('recommendations-playlists-grid');
        const tracksSection = document.getElementById('recommendations-tracks-section');
        const tracksGrid = document.getElementById('recommendations-tracks-grid');
        const emptyState = document.getElementById('recommendations-empty');

        const hasAlbums = data.albums && data.albums.length > 0;
        const hasPlaylists = data.playlists && data.playlists.length > 0;
        const hasTracks = data.tracks && data.tracks.length > 0;

        if (!hasAlbums && !hasPlaylists && !hasTracks) {
            emptyState.style.display = 'block';
            albumsSection.style.display = 'none';
            playlistsSection.style.display = 'none';
            tracksSection.style.display = 'none';
            return;
        }

        emptyState.style.display = 'none';

        // Render albums
        if (hasAlbums) {
            albumsSection.style.display = 'block';
            albumsGrid.innerHTML = data.albums.map(album => `
                <div class="playlist-card" onclick="selectAlbum('${album.id}')">
                    <div class="playlist-cover">
                        ${album.coverUrl
                            ? `<img src="${album.coverUrl}" alt="${escapeHtml(album.title)}" loading="lazy">`
                            : `<div class="playlist-cover-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <circle cx="12" cy="12" r="10"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                               </div>`
                        }
                    </div>
                    <div class="playlist-info">
                        <h3 class="playlist-name">${escapeHtml(album.title)}</h3>
                        <div class="playlist-meta">${escapeHtml(album.artistName || '')}</div>
                        <span class="type-badge type-badge-album">${album.typeLabel || 'Album'}</span>
                    </div>
                </div>
            `).join('');
        } else {
            albumsSection.style.display = 'none';
        }

        // Render playlists
        if (hasPlaylists) {
            playlistsSection.style.display = 'block';
            playlistsGrid.innerHTML = data.playlists.map(playlist => `
                <div class="playlist-card" onclick="selectPlaylist(${playlist.id})">
                    <div class="playlist-cover">
                        ${playlist.coverUrl
                            ? `<img src="${playlist.coverUrl}" alt="${escapeHtml(playlist.name)}" loading="lazy">`
                            : `<div class="playlist-cover-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9 18V5l12-2v13"/>
                                    <circle cx="6" cy="18" r="3"/>
                                    <circle cx="18" cy="16" r="3"/>
                                </svg>
                               </div>`
                        }
                    </div>
                    <div class="playlist-info">
                        <h3 class="playlist-name">${escapeHtml(playlist.name)}</h3>
                        <div class="playlist-meta">${playlist.tracksCount} Titel</div>
                        <span class="type-badge type-badge-playlist">Playlist</span>
                    </div>
                </div>
            `).join('');
        } else {
            playlistsSection.style.display = 'none';
        }

        // Render tracks
        if (hasTracks) {
            tracksSection.style.display = 'block';
            tracksGrid.innerHTML = data.tracks.map(track => `
                <div class="playlist-card track-card" onclick="playTrackDirectly(${track.id}, '${escapeHtml(track.title)}', '${escapeHtml(track.artistName || '')}', '${escapeHtml(track.albumTitle || '')}', '${track.coverUrl || ''}')">
                    <div class="playlist-cover">
                        ${track.coverUrl
                            ? `<img src="${track.coverUrl}" alt="${escapeHtml(track.title)}" loading="lazy">`
                            : `<div class="playlist-cover-placeholder">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9 18V5l12-2v13"/>
                                    <circle cx="6" cy="18" r="3"/>
                                    <circle cx="18" cy="16" r="3"/>
                                </svg>
                               </div>`
                        }
                    </div>
                    <div class="playlist-info">
                        <h3 class="playlist-name">${escapeHtml(track.title)}</h3>
                        <div class="playlist-meta">${escapeHtml(track.artistName || '')}${track.formattedDuration ? ' · ' + track.formattedDuration : ''}</div>
                        ${track.isHiRes ? '<span class="hires-badge">Hi-Res</span>' : ''}
                    </div>
                </div>
            `).join('');
        } else {
            tracksSection.style.display = 'none';
        }
    }

    // Load playlists
    async function loadPlaylists() {
        const creds = await getQobuzCredentials();
        const userId = creds?.userId;
        const authToken = creds?.authToken;

        if (!userId || !authToken) return;

        showLoading();

        try {
            const response = await fetch(`/Qobuz?handler=Playlists&userId=${userId}&authToken=${encodeURIComponent(authToken)}`);
            const data = await response.json();

            if (data.success) {
                renderPlaylists(data.playlists);
            } else {
                showError('Playlists konnten nicht geladen werden');
            }
        } catch (error) {
            console.error('Failed to load playlists:', error);
            showError('Playlists konnten nicht geladen werden');
        }

        hideLoading();
    }

    // Render playlists grid
    function renderPlaylists(playlists) {
        const grid = document.getElementById('playlists-grid');
        const emptyState = document.getElementById('playlists-empty');

        if (!playlists || playlists.length === 0) {
            grid.innerHTML = '';
            emptyState.style.display = 'block';
            return;
        }

        emptyState.style.display = 'none';

        grid.innerHTML = playlists.map(playlist => `
            <div class="playlist-card" onclick="selectPlaylist(${playlist.id})">
                <div class="playlist-cover">
                    ${playlist.coverUrl
                        ? `<img src="${playlist.coverUrl}" alt="${playlist.name}" loading="lazy">`
                        : `<div class="playlist-cover-placeholder">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M9 18V5l12-2v13"/>
                                <circle cx="6" cy="18" r="3"/>
                                <circle cx="18" cy="16" r="3"/>
                            </svg>
                           </div>`
                    }
                </div>
                <div class="playlist-info">
                    <h3 class="playlist-name">${escapeHtml(playlist.name)}</h3>
                    <div class="playlist-meta">${playlist.tracksCount} Titel · ${playlist.formattedDuration}</div>
                </div>
            </div>
        `).join('');
    }

    // Select playlist - load and show tracks
    async function selectPlaylist(playlistId) {
        const creds = await getQobuzCredentials();
        const authToken = creds?.authToken;
        if (!authToken) return;

        showLoading();

        try {
            const response = await fetch(`/Qobuz?handler=PlaylistTracks&playlistId=${playlistId}&authToken=${encodeURIComponent(authToken)}`);
            const data = await response.json();

            if (data.success) {
                showPlaylistDetail(data.playlist, data.tracks);
            } else {
                showError(data.error || 'Playlist konnte nicht geladen werden');
            }
        } catch (error) {
            console.error('Failed to load playlist:', error);
            showError('Playlist konnte nicht geladen werden');
        }

        hideLoading();
    }

    // Show playlist detail view
    function showPlaylistDetail(playlist, tracks) {
        currentTracks = tracks || [];

        // Set source tracking for queue
        currentSourceType = 'playlist';
        currentSourceId = playlist.id ? playlist.id.toString() : null;
        currentSourceName = playlist.name;

        // Update header info
        document.getElementById('detail-name').textContent = playlist.name;
        document.getElementById('detail-description').textContent = playlist.description || '';
        document.getElementById('detail-tracks-count').textContent = `${playlist.tracksCount} Titel`;
        document.getElementById('detail-duration').textContent = playlist.formattedDuration;

        // Update cover
        const cover = document.getElementById('detail-cover');
        const placeholder = document.getElementById('detail-cover-placeholder');
        if (playlist.coverUrl) {
            cover.src = playlist.coverUrl;
            cover.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            cover.style.display = 'none';
            placeholder.style.display = 'flex';
        }

        // Render tracks
        renderTracks(tracks);

        // Show detail section, hide playlists
        loggedInSection.style.display = 'none';
        playlistDetailSection.style.display = 'block';

        // Scroll to top
        window.scrollTo(0, 0);
    }

    // Render tracks list
    function renderTracks(tracks) {
        const tracksList = document.getElementById('tracks-list');

        if (!tracks || tracks.length === 0) {
            tracksList.innerHTML = '<div class="empty-state"><p>Diese Playlist enthält keine Titel.</p></div>';
            return;
        }

        tracksList.innerHTML = tracks.map((track, index) => `
            <div class="track-item${currentTrackIndex === index ? ' playing' : ''}" onclick="playTrack(${index}, event)" data-index="${index}">
                <span class="track-number">${index + 1}</span>
                <button type="button" class="track-play-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        ${currentTrackIndex === index && isPlaying
                            ? '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>'
                            : '<path d="M8 5v14l11-7z"/>'}
                    </svg>
                </button>
                <div class="track-cover">
                    ${track.albumCover
                        ? `<img src="${track.albumCover}" alt="" loading="lazy">`
                        : ''}
                </div>
                <div class="track-info">
                    <div class="track-title">${escapeHtml(track.title)}</div>
                    <div class="track-artist">${escapeHtml(track.artistName || 'Unbekannt')}</div>
                </div>
                ${track.qualityLabel ? `<span class="track-quality">${track.qualityLabel}</span>` : ''}
                <span class="track-duration">${track.formattedDuration}</span>
            </div>
        `).join('');
    }

    // Back to playlists
    function backToPlaylists() {
        playlistDetailSection.style.display = 'none';
        loggedInSection.style.display = 'block';
    }

    // Bluesound status polling
    let bluesoundStatusInterval = null;

    // Play track by index
    async function playTrack(index, event) {
        // Prevent any default behavior and stop propagation
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }

        if (index < 0 || index >= currentTracks.length) return;

        const track = currentTracks[index];
        const creds = await getQobuzCredentials();
        const authToken = creds?.authToken;

        if (!track.isStreamable) {
            showError('Dieser Titel ist nicht streambar');
            return;
        }

        // Show loading state on the track item instead of full overlay
        const trackItem = document.querySelector(`.track-item[data-index="${index}"]`);
        if (trackItem) {
            trackItem.style.opacity = '0.6';
        }

        const selectedPlayer = getSelectedPlayer();

        try {
            // Check if we should play on Bluesound or browser
            if (selectedPlayer.type === 'bluesound' && selectedPlayer.ip) {
                await playOnBluesound(track, index, authToken);
            } else {
                await playOnBrowser(track, index, authToken);
            }
        } catch (error) {
            console.error('Failed to play track:', error);
            showError('Fehler beim Laden des Streams');
        }

        // Restore track item opacity
        if (trackItem) {
            trackItem.style.opacity = '1';
        }
    }

    // Play track in browser
    async function playOnBrowser(track, index, authToken) {
        // Stop Bluesound status polling if active
        stopBluesoundStatusPolling();

        const streamQuality = getStreamQuality();
        const response = await fetch(`/Qobuz?handler=TrackStreamUrl&trackId=${track.id}&authToken=${encodeURIComponent(authToken)}&formatId=${streamQuality}`);
        const data = await response.json();

        if (data.success && data.url) {
            currentTrackIndex = index;

            // Sync playlist with GlobalPlayer for cross-page navigation
            if (window.GlobalPlayer) {
                window.GlobalPlayer.setPlaylist(currentTracks, index);
            }

            // Save queue to database
            await saveQueueToDb(index);

            audioPlayer.src = data.url;
            audioPlayer.play();
            isPlaying = true;

            updateNowPlaying(track);
            updateTrackHighlight();
        } else {
            showError(data.error || 'Stream URL konnte nicht abgerufen werden');
        }
    }

    // Play track on Bluesound player
    async function playOnBluesound(track, index, authToken) {
        // Pause browser playback if active
        if (audioPlayer.src) {
            audioPlayer.pause();
        }

        const selectedPlayer = getSelectedPlayer();
        const streamQuality = getStreamQuality();

        const response = await fetch('?handler=PlayOnBluesound', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: JSON.stringify({
                ip: selectedPlayer.ip,
                port: selectedPlayer.port || 11000,
                trackId: track.id,
                authToken: authToken,
                formatId: streamQuality,
                title: track.title,
                artist: track.artistName,
                album: track.albumTitle,
                imageUrl: track.albumCover
            })
        });

        const data = await response.json();

        if (data.success) {
            currentTrackIndex = index;
            isPlaying = true;

            // Save queue to database
            await saveQueueToDb(index);

            updateNowPlaying(track);
            updateTrackHighlight();

            // Start polling for Bluesound status
            startBluesoundStatusPolling();
        } else {
            showError(data.error || 'Wiedergabe auf Bluesound fehlgeschlagen');
        }
    }

    // Start polling Bluesound player status
    function startBluesoundStatusPolling() {
        stopBluesoundStatusPolling(); // Clear any existing interval

        const selectedPlayer = getSelectedPlayer();
        if (selectedPlayer.type !== 'bluesound' || !selectedPlayer.ip) return;

        // Start client-side progress animation
        startProgressAnimation();

        // Poll every 5 seconds (reduced from 2 seconds)
        bluesoundStatusInterval = setInterval(async () => {
            const player = getSelectedPlayer();
            if (player.type !== 'bluesound' || !player.ip) {
                stopBluesoundStatusPolling();
                return;
            }

            try {
                const response = await fetch(`/Qobuz?handler=BluesoundStatus&ip=${player.ip}&port=${player.port || 11000}`);
                const data = await response.json();

                if (data.success && data.status) {
                    updateBluesoundStatus(data.status);
                }
            } catch (error) {
                console.error('Failed to get Bluesound status:', error);
            }
        }, 5000);
    }

    // Stop polling Bluesound player status
    function stopBluesoundStatusPolling() {
        if (bluesoundStatusInterval) {
            clearInterval(bluesoundStatusInterval);
            bluesoundStatusInterval = null;
        }
        stopProgressAnimation();
    }

    // Start client-side progress bar animation
    function startProgressAnimation() {
        stopProgressAnimation();

        function animateProgress() {
            if (!isPlaying || lastKnownTotal <= 0) {
                progressAnimationFrame = requestAnimationFrame(animateProgress);
                return;
            }

            // Calculate estimated current position based on time elapsed since last status update
            const elapsed = (Date.now() - lastStatusTime) / 1000;
            const estimatedPosition = Math.min(lastKnownPosition + elapsed, lastKnownTotal);
            const progress = (estimatedPosition / lastKnownTotal) * 100;

            // Update global progress bar
            if (window.GlobalPlayer) {
                const progressFill = document.getElementById('global-progress-fill');
                const currentTime = document.getElementById('global-current-time');
                if (progressFill) progressFill.style.width = `${progress}%`;
                if (currentTime) currentTime.textContent = formatTime(estimatedPosition);

                // Update popup progress if open
                const popupProgressFill = document.getElementById('global-popup-progress-fill');
                const popupCurrentTime = document.getElementById('global-popup-current-time');
                if (popupProgressFill) popupProgressFill.style.width = `${progress}%`;
                if (popupCurrentTime) popupCurrentTime.textContent = formatTime(estimatedPosition);
            }

            progressAnimationFrame = requestAnimationFrame(animateProgress);
        }

        progressAnimationFrame = requestAnimationFrame(animateProgress);
    }

    // Stop client-side progress animation
    function stopProgressAnimation() {
        if (progressAnimationFrame) {
            cancelAnimationFrame(progressAnimationFrame);
            progressAnimationFrame = null;
        }
    }

    // Update UI based on Bluesound status
    function updateBluesoundStatus(status, showBar = false) {
        // Update play/pause state
        const wasPlaying = isPlaying;
        isPlaying = status.state === 'play' || status.state === 'stream';

        if (wasPlaying !== isPlaying) {
            updateTrackHighlight();

            // Stop polling if playback paused/stopped (not by us)
            if (!isPlaying && status.state === 'pause') {
                stopBluesoundStatusPolling();
            }
        }

        // Check if track changed (different title)
        const trackChanged = lastTrackTitle !== status.title;

        // Update GlobalPlayer with track info
        if (status.title && window.GlobalPlayer) {
            // Update track info in global player
            window.GlobalPlayer.setCurrentTrack({
                title: status.title,
                artist: status.artist,
                artistName: status.artist,
                album: status.album,
                imageUrl: status.imageUrl,
                albumCover: status.imageUrl
            });

            // Update play state in global player
            window.GlobalPlayer.setPlaying(isPlaying);

            // Show the Now Playing bar if something is playing
            if (showBar && (isPlaying || status.state === 'pause')) {
                window.GlobalPlayer.showBar();
            }

            lastTrackTitle = status.title;
        }

        // Update progress tracking for client-side animation
        if (status.currentSeconds !== undefined && status.totalSeconds !== undefined && status.totalSeconds > 0) {
            // Check if progress significantly differs from our client-side estimate
            const elapsed = (Date.now() - lastStatusTime) / 1000;
            const estimatedPosition = lastKnownPosition + elapsed;
            const actualDiff = Math.abs(status.currentSeconds - estimatedPosition);

            // Update our tracking values
            lastKnownPosition = status.currentSeconds;
            lastKnownTotal = status.totalSeconds;
            lastStatusTime = Date.now();

            // Update total time display (only needs to be done when it changes)
            const totalTimeEl = document.getElementById('global-total-time');
            if (totalTimeEl) totalTimeEl.textContent = formatTime(status.totalSeconds);

            const popupTotalTimeEl = document.getElementById('global-popup-total-time');
            if (popupTotalTimeEl) popupTotalTimeEl.textContent = formatTime(status.totalSeconds);

            // If track changed or progress differs by more than 3 seconds, do an immediate update
            if (trackChanged || actualDiff > 3) {
                const progress = (status.currentSeconds / status.totalSeconds) * 100;
                const progressFill = document.getElementById('global-progress-fill');
                const currentTime = document.getElementById('global-current-time');
                if (progressFill) progressFill.style.width = `${progress}%`;
                if (currentTime) currentTime.textContent = formatTime(status.currentSeconds);

                const popupProgressFill = document.getElementById('global-popup-progress-fill');
                const popupCurrentTime = document.getElementById('global-popup-current-time');
                if (popupProgressFill) popupProgressFill.style.width = `${progress}%`;
                if (popupCurrentTime) popupCurrentTime.textContent = formatTime(status.currentSeconds);
            }
        }

        // Check if playback stopped (track ended)
        if (status.state === 'stop' && wasPlaying) {
            stopBluesoundStatusPolling();
            // Track might have ended, try to play next
            playNext();
        }
    }

    // Play all tracks starting from first
    function playAll() {
        if (currentTracks.length > 0) {
            playTrack(0);
        }
    }

    // Play previous track
    function playPrevious() {
        const selectedPlayer = getSelectedPlayer();
        if (selectedPlayer.type === 'bluesound' && selectedPlayer.ip) {
            // Send previous command to Bluesound
            sendBluesoundControl('previous');
            // Also try to play the previous track from our list
            if (currentTrackIndex > 0) {
                playTrack(currentTrackIndex - 1);
            }
        } else {
            if (currentTrackIndex > 0) {
                playTrack(currentTrackIndex - 1);
            }
        }
    }

    // Play next track
    function playNext() {
        const selectedPlayer = getSelectedPlayer();
        if (currentTrackIndex < currentTracks.length - 1) {
            playTrack(currentTrackIndex + 1);
        } else {
            // End of playlist
            isPlaying = false;
            if (window.GlobalPlayer) window.GlobalPlayer.setPlaying(false);
            if (selectedPlayer.type === 'bluesound') {
                sendBluesoundControl('stop');
                stopBluesoundStatusPolling();
            }
        }
    }

    // Toggle play/pause
    async function togglePlayPause() {
        const selectedPlayer = getSelectedPlayer();
        if (selectedPlayer.type === 'bluesound' && selectedPlayer.ip) {
            // Send play/pause command to Bluesound
            const action = isPlaying ? 'pause' : 'play';
            await sendBluesoundControl(action);
            isPlaying = !isPlaying;
            if (window.GlobalPlayer) window.GlobalPlayer.setPlaying(isPlaying);
            updateTrackHighlight();

            // Stop polling when paused, start when playing
            if (isPlaying) {
                startBluesoundStatusPolling();
            } else {
                stopBluesoundStatusPolling();
            }
        } else {
            if (!audioPlayer.src) return;

            if (isPlaying) {
                audioPlayer.pause();
                isPlaying = false;
            } else {
                audioPlayer.play();
                isPlaying = true;
            }

            if (window.GlobalPlayer) window.GlobalPlayer.setPlaying(isPlaying);
            updateTrackHighlight();
        }
    }

    // Seek to position in seconds
    function seekTo(seconds) {
        const selectedPlayer = getSelectedPlayer();
        if (selectedPlayer.type === 'browser' && audioPlayer.src) {
            audioPlayer.currentTime = seconds;
        }
        // TODO: Add Bluesound seek support if needed
    }

    // Handle player change - called when user switches between browser and Bluesound
    function handlePlayerChange(previousType, newType, newPlayer) {
        if (previousType === 'browser' && newType === 'bluesound') {
            // Switching from browser to Bluesound - pause browser audio
            if (audioPlayer.src && !audioPlayer.paused) {
                audioPlayer.pause();
                isPlaying = false;
                updateTrackHighlight();
            }
        } else if (previousType === 'bluesound' && newType === 'browser') {
            // Switching from Bluesound to browser - stop Bluesound polling
            stopBluesoundStatusPolling();
        }
    }

    // Send control command to Bluesound player
    async function sendBluesoundControl(action) {
        const selectedPlayer = getSelectedPlayer();
        if (!selectedPlayer.ip) return;

        try {
            const response = await fetch('?handler=BluesoundControl', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify({
                    ip: selectedPlayer.ip,
                    port: selectedPlayer.port || 11000,
                    action: action
                })
            });

            const data = await response.json();
            return data.success;
        } catch (error) {
            console.error('Failed to send Bluesound control:', error);
            return false;
        }
    }

    // Update now playing bar via GlobalPlayer
    function updateNowPlaying(track) {
        // Store track info for quality switching
        currentTrackInfo = track;
        lastTrackTitle = track.title;

        // Update GlobalPlayer
        if (window.GlobalPlayer) {
            window.GlobalPlayer.setCurrentTrack({
                title: track.title,
                artist: track.artistName,
                artistName: track.artistName,
                album: track.albumTitle,
                imageUrl: track.albumCover,
                albumCover: track.albumCover
            });

            window.GlobalPlayer.setPlaying(isPlaying);
        }
    }

    // ==================== Quality Settings (via GlobalPlayer) ====================

    let currentTrackInfo = null; // Store current track info for quality switching

    // Note: Quality selection is now handled by GlobalPlayer popup
    // This function is called when GlobalPlayer quality changes and we need to restart current track
    window.onGlobalQualityChange = async function(formatId) {
        const selectedPlayer = getSelectedPlayer();
        // If something is playing, restart with new quality
        if (currentTrackInfo && (isPlaying || audioPlayer.currentTime > 0)) {
            const currentTime = selectedPlayer.type === 'browser' ? audioPlayer.currentTime : null;

            showLoading();
            try {
                // Get new stream URL with new quality
                const creds = await getQobuzCredentials();
                if (!creds?.authToken) {
                    hideLoading();
                    return;
                }

                const response = await fetch(`/Qobuz?handler=TrackStreamUrl&trackId=${currentTrackInfo.id}&authToken=${encodeURIComponent(creds.authToken)}&formatId=${formatId}`);
                const data = await response.json();

                if (data.success && data.url) {
                    if (selectedPlayer.type === 'browser') {
                        // Browser playback - restart at position
                        const wasPlaying = isPlaying;
                        audioPlayer.src = data.url;
                        audioPlayer.load();

                        audioPlayer.addEventListener('loadedmetadata', function onLoaded() {
                            if (currentTime) {
                                audioPlayer.currentTime = currentTime;
                            }
                            if (wasPlaying) {
                                audioPlayer.play();
                            }
                            audioPlayer.removeEventListener('loadedmetadata', onLoaded);
                        });
                    } else if (selectedPlayer.type === 'bluesound') {
                        // Bluesound playback - restart with new quality
                        const playResponse = await fetch('?handler=PlayOnBluesound', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                            },
                            body: JSON.stringify({
                                ip: selectedPlayer.ip,
                                port: selectedPlayer.port || 11000,
                                trackId: currentTrackInfo.id,
                                authToken: creds.authToken,
                                formatId: formatId,
                                title: currentTrackInfo.title,
                                artist: currentTrackInfo.artistName,
                                album: currentTrackInfo.albumTitle,
                                imageUrl: currentTrackInfo.albumCover
                            })
                        });

                        const playData = await playResponse.json();
                        if (!playData.success) {
                            throw new Error('Failed to restart on Bluesound');
                        }
                    }
                } else {
                    showError('Qualität konnte nicht geändert werden');
                }
            } catch (error) {
                console.error('Failed to change quality:', error);
                showError('Qualität konnte nicht geändert werden');
            }
            hideLoading();
        }
    };

    // Update track highlight in list
    function updateTrackHighlight() {
        document.querySelectorAll('.track-item').forEach((item, index) => {
            item.classList.toggle('playing', index === currentTrackIndex);

            const btn = item.querySelector('.track-play-btn svg');
            if (index === currentTrackIndex && isPlaying) {
                btn.innerHTML = '<path d="M6 4h4v16H6zM14 4h4v16h-4z"/>';
            } else {
                btn.innerHTML = '<path d="M8 5v14l11-7z"/>';
            }
        });
    }

    // Update progress bar for browser playback (updates GlobalPlayer)
    function updateProgress() {
        if (!audioPlayer.duration) return;

        if (window.GlobalPlayer) {
            window.GlobalPlayer.updateProgress(audioPlayer.currentTime, audioPlayer.duration);
        }
    }

    // Update total time display
    function updateTotalTime() {
        if (window.GlobalPlayer && audioPlayer.duration) {
            window.GlobalPlayer.updateProgress(audioPlayer.currentTime, audioPlayer.duration);
        }
    }

    // Format time as m:ss
    function formatTime(seconds) {
        if (!seconds || isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // Logout
    async function logout() {
        // Stop playback
        if (audioPlayer) {
            audioPlayer.pause();
            audioPlayer.src = '';
        }
        isPlaying = false;
        currentTracks = [];
        currentTrackIndex = -1;
        stopBluesoundStatusPolling();

        // Reset global player state (but keep bar visible)
        if (window.GlobalPlayer) {
            window.GlobalPlayer.setPlaying(false);
            window.GlobalPlayer.setCurrentTrack({
                title: 'Kein Titel',
                artist: '-',
                albumCover: null
            });
            window.GlobalPlayer.updateProgress(0, 0);
        }

        await clearSession();
        loginSection.style.display = 'flex';
        loggedInSection.style.display = 'none';
        playlistDetailSection.style.display = 'none';
        userMenu.style.display = 'none';
        document.getElementById('playlists-grid').innerHTML = '';
    }

    // Clear session data (from active profile)
    async function clearSession() {
        await clearQobuzCredentials();
    }

    // ==================== Player Selector (now handled by GlobalPlayer) ====================

    // Open player selector via GlobalPlayer
    async function openPlayerSelector() {
        if (window.openGlobalPlayerSelector) {
            window.openGlobalPlayerSelector();
        }
    }

    // Close player selector (handled by GlobalPlayer)
    function closePlayerSelector() {
        if (window.closeGlobalPlayerSelector) {
            window.closeGlobalPlayerSelector();
        }
    }

    // Note: Player selection and stream quality are now handled by GlobalPlayer

    // Check current playback status on page load (for Qobuz page-specific track list highlighting)
    async function checkCurrentPlayback() {
        const selectedPlayer = getSelectedPlayer();
        if (selectedPlayer.type !== 'bluesound' || !selectedPlayer.ip) {
            return;
        }

        try {
            const response = await fetch(`/Qobuz?handler=BluesoundStatus&ip=${selectedPlayer.ip}&port=${selectedPlayer.port || 11000}`);
            const data = await response.json();

            if (data.success && data.status) {
                // Update the Now Playing bar with current status
                updateBluesoundStatus(data.status, true);

                // Start polling if something is playing
                if (data.status.state === 'play' || data.status.state === 'stream') {
                    startBluesoundStatusPolling();
                }
            }
        } catch (error) {
            console.error('Failed to check current playback:', error);
        }
    }

    // Check playback after page is ready
    checkCurrentPlayback();

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
