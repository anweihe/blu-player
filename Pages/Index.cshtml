@page
@model IndexModel
@{
    ViewData["Title"] = "Musik streamen";
    ViewData["ShowHamburgerMenu"] = false;
}

<div class="source-app">
    <!-- Header -->
    <header class="source-header">
        <div class="header-content">
            <div class="brand">
                <svg class="brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 2v4M12 18v4M2 12h4M18 12h4"/>
                </svg>
                <h1>Bluesound</h1>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="source-main">
        <div class="source-container">
            <h2 class="source-title">Musik streamen</h2>
            <p class="source-subtitle">Wahle eine Quelle um loszulegen</p>

            <div class="source-grid">
                <!-- Qobuz Source -->
                <button type="button" class="source-card" onclick="selectSource('qobuz')">
                    <div class="source-icon qobuz-icon">
                        <svg viewBox="0 0 100 100" fill="currentColor">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="currentColor" stroke-width="6"/>
                            <circle cx="50" cy="50" r="20"/>
                        </svg>
                    </div>
                    <span class="source-name">Qobuz</span>
                    <span class="source-desc">Hi-Res Streaming</span>
                </button>

                <!-- Future sources can be added here -->
            </div>

            <a href="/Players" class="players-link">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="4" y="4" width="16" height="16" rx="2"/>
                    <circle cx="12" cy="12" r="3"/>
                    <path d="M12 9v-2M12 17v-2M9 12H7M17 12h-2"/>
                </svg>
                <span>Bluesound Players verwalten</span>
            </a>
        </div>
    </main>

    <!-- User Selection Overlay -->
    <div id="user-overlay" class="user-overlay">
        <div class="user-modal">
            <div class="user-modal-header">
                <h3>Wer streamt?</h3>
                <button type="button" class="btn-close-modal" onclick="closeUserOverlay()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <div class="user-grid" id="user-grid">
                <!-- Profiles will be rendered here -->
            </div>
            <button type="button" class="btn-add-user" onclick="showAddProfileDialog()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                <span>Profil hinzufugen</span>
            </button>
        </div>
    </div>

    <!-- Add Profile Dialog -->
    <div id="add-profile-dialog" class="add-profile-dialog">
        <div class="add-profile-modal">
            <div class="add-profile-header">
                <h3>Neues Profil</h3>
            </div>
            <form id="add-profile-form" onsubmit="createProfile(event)">
                <div class="form-group">
                    <label for="profile-name">Name</label>
                    <input type="text" id="profile-name" placeholder="z.B. Max" required autofocus>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeAddProfileDialog()">Abbrechen</button>
                    <button type="submit" class="btn-primary">Erstellen</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="~/js/user-profiles.js"></script>

<style>
    /* CSS Variables */
    :root {
        --bg-primary: #0a0a0b;
        --bg-secondary: #111113;
        --bg-card: #161618;
        --bg-card-hover: #1c1c1f;
        --border-subtle: rgba(255, 255, 255, 0.06);
        --border-accent: rgba(255, 255, 255, 0.1);
        --text-primary: #f4f4f5;
        --text-secondary: #a1a1aa;
        --text-muted: #71717a;
        --accent-qobuz: #1db954;
        --accent-blue: #3b82f6;
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 14px;
        --radius-xl: 20px;
        --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.2);
        --shadow-modal: 0 25px 50px rgba(0, 0, 0, 0.5);
        --transition: 0.15s ease;
    }

    /* Base */
    .source-app {
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        background: var(--bg-primary);
        min-height: 100vh;
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
    }

    /* Header */
    .source-header {
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border-subtle);
        padding: 0 max(16px, env(safe-area-inset-left));
        padding-top: env(safe-area-inset-top);
    }

    .source-header .header-content {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 14px 0;
        max-width: 1200px;
        margin: 0 auto;
    }

    .brand {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .brand-icon {
        width: 28px;
        height: 28px;
        color: var(--text-primary);
    }

    .brand h1 {
        font-size: 1.25rem;
        font-weight: 600;
        letter-spacing: -0.02em;
        margin: 0;
    }

    /* Main Content */
    .source-main {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: calc(100vh - 60px);
        padding: 40px 20px;
    }

    .source-container {
        text-align: center;
        max-width: 600px;
        width: 100%;
    }

    .source-title {
        font-size: 2rem;
        font-weight: 700;
        margin: 0 0 8px;
        letter-spacing: -0.02em;
    }

    .source-subtitle {
        font-size: 1rem;
        color: var(--text-secondary);
        margin: 0 0 40px;
    }

    /* Source Grid */
    .source-grid {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-bottom: 60px;
    }

    .source-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
        padding: 32px;
        width: 180px;
        background: var(--bg-card);
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-xl);
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .source-card:hover {
        background: var(--bg-card-hover);
        border-color: var(--accent-qobuz);
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
    }

    .source-card:active {
        transform: translateY(-2px);
    }

    .source-icon {
        width: 80px;
        height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(29, 185, 84, 0.1);
    }

    .source-icon svg {
        width: 48px;
        height: 48px;
    }

    .qobuz-icon {
        color: var(--accent-qobuz);
    }

    .source-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .source-desc {
        font-size: 0.8rem;
        color: var(--text-muted);
    }

    /* Players Link */
    .players-link {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        padding: 14px 24px;
        background: var(--bg-card);
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 0.9rem;
        transition: all var(--transition);
    }

    .players-link:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .players-link svg {
        width: 20px;
        height: 20px;
    }

    /* User Overlay */
    .user-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: 20px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .user-overlay.active {
        display: flex;
        opacity: 1;
    }

    .user-modal {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: var(--shadow-modal);
        animation: modalIn 0.25s ease;
    }

    @@keyframes modalIn {
        from {
            transform: scale(0.95);
            opacity: 0;
        }
        to {
            transform: scale(1);
            opacity: 1;
        }
    }

    .user-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 24px;
        border-bottom: 1px solid var(--border-subtle);
    }

    .user-modal-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .btn-close-modal {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        background: transparent;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        border-radius: var(--radius-sm);
        transition: all var(--transition);
    }

    .btn-close-modal:hover {
        background: var(--bg-card);
        color: var(--text-primary);
    }

    .btn-close-modal svg {
        width: 20px;
        height: 20px;
    }

    /* User Grid */
    .user-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 16px;
        padding: 24px;
        overflow-y: auto;
        flex: 1;
    }

    .user-card {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        padding: 20px 16px;
        background: var(--bg-card);
        border: 2px solid transparent;
        border-radius: var(--radius-md);
        cursor: pointer;
        transition: all var(--transition);
    }

    .user-card:hover {
        background: var(--bg-card-hover);
        border-color: var(--border-accent);
    }

    .user-card.selected {
        border-color: var(--accent-qobuz);
        background: rgba(29, 185, 84, 0.1);
    }

    .user-avatar {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 600;
        color: white;
    }

    .user-name {
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-primary);
        text-align: center;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .user-status {
        font-size: 0.7rem;
        color: var(--accent-qobuz);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .user-status svg {
        width: 12px;
        height: 12px;
    }

    /* Add User Button */
    .btn-add-user {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        width: 100%;
        padding: 16px;
        background: transparent;
        border: none;
        border-top: 1px solid var(--border-subtle);
        color: var(--text-secondary);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all var(--transition);
    }

    .btn-add-user:hover {
        background: var(--bg-card);
        color: var(--text-primary);
    }

    .btn-add-user svg {
        width: 20px;
        height: 20px;
    }

    /* Add Profile Dialog */
    .add-profile-dialog {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(8px);
        -webkit-backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1100;
        padding: 20px;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .add-profile-dialog.active {
        display: flex;
        opacity: 1;
    }

    .add-profile-modal {
        background: var(--bg-secondary);
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 400px;
        padding: 24px;
        box-shadow: var(--shadow-modal);
        animation: modalIn 0.25s ease;
    }

    .add-profile-header h3 {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0 0 20px;
        text-align: center;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 6px;
    }

    .form-group input {
        width: 100%;
        padding: 12px 14px;
        background: var(--bg-card);
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-md);
        color: var(--text-primary);
        font-size: 1rem;
        transition: all var(--transition);
    }

    .form-group input:focus {
        outline: none;
        border-color: var(--accent-qobuz);
        box-shadow: 0 0 0 3px rgba(29, 185, 84, 0.1);
    }

    .form-group input::placeholder {
        color: var(--text-muted);
    }

    .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .btn-secondary {
        padding: 10px 20px;
        background: var(--bg-card);
        border: 1px solid var(--border-accent);
        border-radius: var(--radius-md);
        color: var(--text-secondary);
        font-size: 0.9rem;
        cursor: pointer;
        transition: all var(--transition);
    }

    .btn-secondary:hover {
        background: var(--bg-card-hover);
        color: var(--text-primary);
    }

    .btn-primary {
        padding: 10px 20px;
        background: var(--accent-qobuz);
        border: none;
        border-radius: var(--radius-md);
        color: white;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition);
    }

    .btn-primary:hover {
        background: #1ed760;
    }

    /* Mobile */
    @@media (max-width: 480px) {
        .source-title {
            font-size: 1.5rem;
        }

        .source-grid {
            flex-direction: column;
            align-items: center;
        }

        .source-card {
            width: 100%;
            max-width: 200px;
        }

        .user-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .user-avatar {
            width: 56px;
            height: 56px;
            font-size: 1.25rem;
        }
    }

    /* Light mode */
    @@media (prefers-color-scheme: light) {
        :root {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --bg-card-hover: #f8f9fa;
            --border-subtle: rgba(0, 0, 0, 0.06);
            --border-accent: rgba(0, 0, 0, 0.1);
            --text-primary: #18181b;
            --text-secondary: #52525b;
            --text-muted: #a1a1aa;
            --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-modal: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        .user-overlay,
        .add-profile-dialog {
            background: rgba(0, 0, 0, 0.5);
        }
    }
</style>

<script>
    // State
    let selectedSource = null;

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize profile manager and perform migration
        UserProfileManager.initialize();

        // Check if there are any profiles
        const profiles = UserProfileManager.getAllProfiles();
        if (profiles.length === 0) {
            // No profiles - show add profile dialog directly
            showAddProfileDialog();
        }
    });

    // Select a music source
    function selectSource(source) {
        selectedSource = source;
        showUserOverlay();
    }

    // Show user selection overlay
    function showUserOverlay() {
        const overlay = document.getElementById('user-overlay');
        renderUserGrid();
        overlay.classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    // Close user selection overlay
    function closeUserOverlay() {
        const overlay = document.getElementById('user-overlay');
        overlay.classList.remove('active');
        document.body.style.overflow = '';
        selectedSource = null;
    }

    // Render user grid
    function renderUserGrid() {
        const grid = document.getElementById('user-grid');
        const profiles = UserProfileManager.getAllProfiles();
        const activeProfileId = UserProfileManager.getActiveProfileId();

        if (profiles.length === 0) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-muted); padding: 20px;">Noch keine Profile erstellt</div>';
            return;
        }

        grid.innerHTML = profiles.map(profile => {
            const initial = UserProfileManager.getProfileInitial(profile.name);
            const color = UserProfileManager.getProfileColor(profile.id);
            const hasQobuz = profile.qobuz && profile.qobuz.userId;
            const isActive = profile.id === activeProfileId;

            return `
                <div class="user-card ${isActive ? 'selected' : ''}" onclick="selectUser('${profile.id}')">
                    <div class="user-avatar" style="background: ${color}">${initial}</div>
                    <span class="user-name">${escapeHtml(profile.name)}</span>
                    ${hasQobuz ? `
                        <span class="user-status">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                <path d="M20 6L9 17l-5-5"/>
                            </svg>
                            Login
                        </span>
                    ` : ''}
                </div>
            `;
        }).join('');
    }

    // Select a user profile
    function selectUser(profileId) {
        // Set the profile as active
        UserProfileManager.setActiveProfileId(profileId);

        // Get the profile to check if Qobuz is logged in
        const profile = UserProfileManager.getProfileById(profileId);

        // Save the source before closing (closeUserOverlay resets selectedSource)
        const source = selectedSource;

        // Close overlay
        closeUserOverlay();

        // Navigate to Qobuz page
        if (source === 'qobuz') {
            window.location.href = '/Qobuz';
        }
    }

    // Show add profile dialog
    function showAddProfileDialog() {
        const dialog = document.getElementById('add-profile-dialog');
        dialog.classList.add('active');
        document.body.style.overflow = 'hidden';

        // Focus input
        setTimeout(() => {
            document.getElementById('profile-name').focus();
        }, 100);
    }

    // Close add profile dialog
    function closeAddProfileDialog() {
        const dialog = document.getElementById('add-profile-dialog');
        dialog.classList.remove('active');
        document.getElementById('profile-name').value = '';

        // Restore body scroll only if user overlay is not active
        const userOverlay = document.getElementById('user-overlay');
        if (!userOverlay.classList.contains('active')) {
            document.body.style.overflow = '';
        }
    }

    // Create new profile
    function createProfile(event) {
        event.preventDefault();

        const nameInput = document.getElementById('profile-name');
        const name = nameInput.value.trim();

        if (!name) return;

        // Create the profile
        const newProfile = UserProfileManager.createProfile(name);

        // Set as active
        UserProfileManager.setActiveProfileId(newProfile.id);

        // Close dialog
        closeAddProfileDialog();

        // If user overlay is open, refresh the grid
        const userOverlay = document.getElementById('user-overlay');
        if (userOverlay.classList.contains('active')) {
            renderUserGrid();
        } else {
            // If this was the first profile, go ahead and select a source
            showUserOverlay();
        }
    }

    // Escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Close overlays on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const addDialog = document.getElementById('add-profile-dialog');
            const userOverlay = document.getElementById('user-overlay');

            if (addDialog.classList.contains('active')) {
                closeAddProfileDialog();
            } else if (userOverlay.classList.contains('active')) {
                closeUserOverlay();
            }
        }
    });

    // Close user overlay when clicking outside
    document.getElementById('user-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
            closeUserOverlay();
        }
    });

    // Close add profile dialog when clicking outside
    document.getElementById('add-profile-dialog').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddProfileDialog();
        }
    });
</script>
