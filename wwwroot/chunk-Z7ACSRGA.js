import{M as u,Q as d,ac as c,f as n,ha as l,z as r}from"./chunk-MM2V5YAY.js";var h=class a{constructor(e){this.http=e;this.requestSubject.pipe(r(this.DEBOUNCE_MS)).subscribe(()=>this.processBatch())}API_URL="/Api/Ratings";DEBOUNCE_MS=300;cache=new Map;_ratingsUpdated=l(0);ratingsUpdated=this._ratingsUpdated.asReadonly();pendingRequests=[];requestSubject=new n;inFlightIds=new Set;fetchRatings(e){if(!e||e.length===0)return;let i=e.filter(s=>{let t=s.albumId;return t&&!this.cache.has(t)&&!this.inFlightIds.has(t)});i.length!==0&&(i.forEach(s=>this.inFlightIds.add(s.albumId)),this.pendingRequests.push(...i),this.requestSubject.next())}getRating(e){return this.cache.get(e)}hasRating(e){return this.cache.has(e)}processBatch(){if(this.pendingRequests.length===0)return;let e=[...this.pendingRequests];this.pendingRequests=[];let i=this.deduplicateRequests(e);i.length!==0&&this.http.post(this.API_URL,{albums:i}).subscribe({next:s=>{s.success&&s.data?(s.data.forEach(t=>{this.cache.set(t.albumId,t),this.inFlightIds.delete(t.albumId)}),i.forEach(t=>{this.cache.has(t.albumId)||this.cache.set(t.albumId,{albumId:t.albumId,userScore:null,criticsScore:null}),this.inFlightIds.delete(t.albumId)}),this._ratingsUpdated.update(t=>t+1)):i.forEach(t=>this.inFlightIds.delete(t.albumId))},error:()=>{i.forEach(s=>this.inFlightIds.delete(s.albumId))}})}deduplicateRequests(e){let i=new Set;return e.filter(s=>i.has(s.albumId)?!1:(i.add(s.albumId),!0))}clearCache(){this.cache.clear(),this.inFlightIds.clear(),this.pendingRequests=[],this._ratingsUpdated.update(e=>e+1)}static \u0275fac=function(i){return new(i||a)(d(c))};static \u0275prov=u({token:a,factory:a.\u0275fac,providedIn:"root"})};export{h as a};
