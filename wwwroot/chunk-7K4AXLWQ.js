import{a as S}from"./chunk-Q6FVMT4J.js";import{a as f}from"./chunk-N2MVT66X.js";import{a as b}from"./chunk-HEQVEB5Z.js";import{G as c,H as m,M as P,R as o,a as u,b as p,f as y,ha as l,n as s,v as h}from"./chunk-F7VV2WDX.js";var g=class n{playerState=o(f);bluesoundApi=o(S);qobuzApi=o(b);audioElement=null;animationFrameId=null;lastProgressUpdate=0;currentContext=null;destroy$=new y;pollingSubscription=null;isLoading=l(!1);loadingTrackId=l(null);isBrowserPlaying=l(!1);constructor(){this.initAudioElement(),this.setupModeWatcher()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.stopProgressAnimation(),this.disposeAudioElement(),this.stopPolling()}initAudioElement(){typeof window<"u"&&(this.audioElement=new Audio,this.audioElement.preload="metadata",this.audioElement.addEventListener("play",()=>this.onAudioPlay()),this.audioElement.addEventListener("pause",()=>this.onAudioPause()),this.audioElement.addEventListener("ended",()=>this.onAudioEnded()),this.audioElement.addEventListener("timeupdate",()=>this.onTimeUpdate()),this.audioElement.addEventListener("loadedmetadata",()=>this.onLoadedMetadata()),this.audioElement.addEventListener("error",t=>this.onAudioError(t)))}disposeAudioElement(){this.audioElement&&(this.audioElement.pause(),this.audioElement.src="",this.audioElement=null)}setupModeWatcher(){}async playTrack(t,e){this.isLoading.set(!0),this.loadingTrackId.set(t.id);try{this.playerState.currentTrack.set(t),this.playerState.duration.set(t.duration||0),this.playerState.progress.set(0),e&&(this.currentContext=e),this.playerState.playerMode()==="browser"?await this.playTrackInBrowser(t):await this.playTrackOnBluesound(t)}catch(i){console.error("Failed to play track:",i)}finally{this.isLoading.set(!1),this.loadingTrackId.set(null)}}async playAlbum(t,e,i=0){if(!t.id){console.error("Album has no ID");return}let a={type:"album",id:t.id,tracks:e,startIndex:i},d=this.playerState.playerMode(),r=this.playerState.selectedPlayer();if(d==="bluesound"&&r){this.isLoading.set(!0);try{await s(this.bluesoundApi.playQobuzAlbum(r.ipAddress,t.id,i)),this.startPolling()}finally{this.isLoading.set(!1)}}else e[i]&&await this.playTrack(e[i],a)}async playPlaylist(t,e,i=0){let a={type:"playlist",id:t.id,tracks:e,startIndex:i},d=this.playerState.playerMode(),r=this.playerState.selectedPlayer();if(d==="bluesound"&&r){this.isLoading.set(!0);try{await s(this.bluesoundApi.playQobuzPlaylist(r.ipAddress,t.id,i)),this.startPolling()}finally{this.isLoading.set(!1)}}else e[i]&&await this.playTrack(e[i],a)}async playTrackInBrowser(t){if(this.audioElement)try{let e=this.playerState.streamingQuality(),i=await s(this.qobuzApi.getTrackStreamUrl(t.id,e));this.audioElement.pause(),this.audioElement.src=i,this.audioElement.volume=this.playerState.isMuted()?0:this.playerState.volume()/100,await this.audioElement.play(),this.startProgressAnimation()}catch(e){throw console.error("Failed to play track in browser:",e),e}}async playTrackOnBluesound(t){let e=this.playerState.selectedPlayer();if(!e){console.error("No Bluesound player selected");return}try{await s(this.bluesoundApi.playQobuzTrack(e.ipAddress,t.id)),this.startPolling()}catch(i){throw console.error("Failed to play track on Bluesound:",i),i}}async togglePlayPause(){let t=this.playerState.playerMode(),e=this.playerState.isPlaying();if(t==="browser")this.audioElement&&(e||!this.audioElement.paused?this.audioElement.pause():(await this.audioElement.play(),this.startProgressAnimation()));else{let i=this.playerState.selectedPlayer();i&&(e?await s(this.bluesoundApi.pause(i.ipAddress)):await s(this.bluesoundApi.play(i.ipAddress)))}}async play(){if(this.playerState.playerMode()==="browser")this.audioElement&&this.audioElement.paused&&(await this.audioElement.play(),this.startProgressAnimation());else{let e=this.playerState.selectedPlayer();e&&await s(this.bluesoundApi.play(e.ipAddress))}}async pause(){if(this.playerState.playerMode()==="browser")this.audioElement?.pause();else{let e=this.playerState.selectedPlayer();e&&await s(this.bluesoundApi.pause(e.ipAddress))}}async stop(){if(this.playerState.playerMode()==="browser")this.audioElement&&(this.audioElement.pause(),this.audioElement.currentTime=0),this.stopProgressAnimation(),this.playerState.reset();else{let e=this.playerState.selectedPlayer();e&&await s(this.bluesoundApi.stop(e.ipAddress))}}async skipNext(){if(this.playerState.playerMode()==="browser"){if(this.currentContext){let e=this.currentContext.startIndex+1;e<this.currentContext.tracks.length&&(this.currentContext.startIndex=e,await this.playTrack(this.currentContext.tracks[e],this.currentContext))}}else{let e=this.playerState.selectedPlayer();e&&await s(this.bluesoundApi.skip(e.ipAddress))}}async skipPrevious(){if(this.playerState.playerMode()==="browser"){if(this.audioElement&&this.audioElement.currentTime>3){this.audioElement.currentTime=0;return}if(this.currentContext){let e=this.currentContext.startIndex-1;e>=0&&(this.currentContext.startIndex=e,await this.playTrack(this.currentContext.tracks[e],this.currentContext))}}else{let e=this.playerState.selectedPlayer();e&&await s(this.bluesoundApi.back(e.ipAddress))}}async seek(t){if(this.playerState.playerMode()==="browser")this.audioElement&&(this.audioElement.currentTime=t,this.playerState.updateProgress(t));else{let i=this.playerState.selectedPlayer();i&&await s(this.bluesoundApi.seek(i.ipAddress,t))}}async seekToPercent(t){let e=this.playerState.duration();if(e>0){let i=t/100*e;await this.seek(i)}}async setVolume(t){let e=Math.max(0,Math.min(100,t));if(this.playerState.setVolume(e),this.playerState.playerMode()==="browser")this.audioElement&&(this.audioElement.volume=e/100);else{let a=this.playerState.selectedPlayer();a&&!a.isFixedVolume&&await s(this.bluesoundApi.setVolume(a.ipAddress,e))}}async toggleMute(){let t=this.playerState.isMuted();if(this.playerState.toggleMute(),this.playerState.playerMode()==="browser")this.audioElement&&(this.audioElement.volume=t?this.playerState.volume()/100:0);else{let i=this.playerState.selectedPlayer();i&&await s(this.bluesoundApi.setMute(i.ipAddress,!t))}}setQuality(t){this.playerState.setStreamingQuality(t)}async switchToBrowser(){let t=this.playerState.selectedPlayer();if(t)try{await s(this.bluesoundApi.stop(t.ipAddress))}catch{}this.stopPolling(),this.playerState.useBrowserPlayback()}async switchToBluesound(t){this.audioElement&&(this.audioElement.pause(),this.audioElement.src=""),this.stopProgressAnimation(),this.playerState.selectPlayer(t),this.startPolling()}onAudioPlay(){this.isBrowserPlaying.set(!0);let t=this.playerState.playbackStatus();if(t)this.playerState.updatePlaybackStatus(p(u({},t),{state:"play"}));else{let e=this.playerState.currentTrack();e&&this.playerState.updatePlaybackStatus({state:"play",title:e.title,artist:e.performer?.name,album:e.album?.title,imageUrl:e.album?.image?.large,totalSeconds:e.duration,currentSeconds:0,artistId:e.performer?.id})}}onAudioPause(){this.isBrowserPlaying.set(!1),this.stopProgressAnimation();let t=this.playerState.playbackStatus();t&&this.playerState.updatePlaybackStatus(p(u({},t),{state:"pause"}))}onAudioEnded(){this.isBrowserPlaying.set(!1),this.stopProgressAnimation(),this.currentContext&&this.skipNext()}onTimeUpdate(){this.audioElement&&this.playerState.updateProgress(this.audioElement.currentTime)}onLoadedMetadata(){this.audioElement&&this.playerState.duration.set(this.audioElement.duration)}onAudioError(t){console.error("Audio playback error:",t),this.isBrowserPlaying.set(!1),this.stopProgressAnimation()}startProgressAnimation(){this.stopProgressAnimation(),this.lastProgressUpdate=performance.now(),this.animateProgress()}stopProgressAnimation(){this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animateProgress=()=>{if(!this.audioElement||this.audioElement.paused)return;let t=performance.now(),e=(t-this.lastProgressUpdate)/1e3;this.lastProgressUpdate=t;let a=this.playerState.progress()+e;a<=this.playerState.duration()&&this.playerState.updateProgress(a),this.animationFrameId=requestAnimationFrame(this.animateProgress)};startPolling(){this.stopPolling();let t=this.playerState.selectedPlayer();t&&(this.pollingSubscription=h(1e3).pipe(m(this.destroy$),c(()=>this.bluesoundApi.getStatus(t.ipAddress))).subscribe(e=>{e&&this.playerState.updatePlaybackStatus(e)}))}stopPolling(){this.pollingSubscription&&(this.pollingSubscription.unsubscribe(),this.pollingSubscription=null)}async addToQueue(t){let e=this.playerState.playerMode(),i=this.playerState.selectedPlayer();e==="bluesound"&&i?await s(this.bluesoundApi.addToQueue(i.ipAddress,t.id)):this.currentContext&&this.currentContext.tracks.push(t)}async clearQueue(){let t=this.playerState.playerMode(),e=this.playerState.selectedPlayer();t==="bluesound"&&e&&await s(this.bluesoundApi.clearQueue(e.ipAddress)),this.playerState.clearQueue(),this.currentContext=null}async loadQueue(){let t=this.playerState.selectedPlayer();if(!t)return;let e=await s(this.bluesoundApi.getQueue(t.ipAddress));this.playerState.setQueue(e)}static \u0275fac=function(e){return new(e||n)};static \u0275prov=P({token:n,factory:n.\u0275fac,providedIn:"root"})};export{g as a};
