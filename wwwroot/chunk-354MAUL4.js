import{a as m}from"./chunk-O66JSED4.js";import{g as I}from"./chunk-NROGR6IW.js";import{l as w}from"./chunk-N35TVY3C.js";import{H as S,I as A,N as c,S as p,a as v,b as f,ec as k,f as g,ia as h,j as i,n as o,o as l,v as P,y as r}from"./chunk-TWVQ6WYG.js";var b=class d{http=p(k);auth=p(w);playerState=p(m);apiBaseUrl="/api";qobuzApiUrl="/api/qobuz";getPlayers(){return this.http.get(`${this.apiBaseUrl}/players`).pipe(r(()=>i([])))}refreshPlayers(){return this.http.post(`${this.apiBaseUrl}/players/refresh`,{}).pipe(r(()=>i([])))}getSyncStatus(e){return this.http.get(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/sync`).pipe(r(()=>i(null)))}getStatus(e){return this.http.get(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/status`).pipe(r(()=>i(null)))}getQueue(e){return this.http.get(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/queue`).pipe(r(()=>i([])))}play(e){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/play`,{}).pipe(l(()=>!0),r(()=>i(!1)))}pause(e){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/pause`,{}).pipe(l(()=>!0),r(()=>i(!1)))}stop(e){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/stop`,{}).pipe(l(()=>!0),r(()=>i(!1)))}skip(e){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/skip`,{}).pipe(l(()=>!0),r(()=>i(!1)))}back(e){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/back`,{}).pipe(l(()=>!0),r(()=>i(!1)))}seek(e,t){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/seek`,{seconds:t}).pipe(l(()=>!0),r(()=>i(!1)))}setVolume(e,t){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/volume`,{level:t}).pipe(l(()=>!0),r(()=>i(!1)))}setMute(e,t){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/mute`,{mute:t}).pipe(l(()=>!0),r(()=>i(!1)))}playQobuzTrackNative(e,t,a,s){let n=s.type==="album"?{ip:e,port:11e3,sourceType:"album",albumId:s.albumId,trackId:t,trackIndex:a}:{ip:e,port:11e3,sourceType:"playlist",playlistId:s.playlistId,trackId:t,trackIndex:a};return this.http.post(`${this.qobuzApiUrl}/play-native-on-bluesound`,n).pipe(l(u=>u.success),r(u=>(console.error("Failed to play track on Bluesound:",u),i(!1))))}playQobuzTrack(e,t,a){return console.warn("playQobuzTrack called without context - native playback requires album/playlist context"),i(!1)}playQobuzAlbum(e,t,a=0,s){return s||console.warn("playQobuzAlbum called without trackId - native playback may not work correctly"),this.http.post(`${this.qobuzApiUrl}/play-native-on-bluesound`,{ip:e,port:11e3,sourceType:"album",albumId:t,trackId:s??0,trackIndex:a}).pipe(l(n=>n.success),r(n=>(console.error("Failed to play album on Bluesound:",n),i(!1))))}playQobuzPlaylist(e,t,a=0,s){return s||console.warn("playQobuzPlaylist called without trackId - native playback may not work correctly"),this.http.post(`${this.qobuzApiUrl}/play-native-on-bluesound`,{ip:e,port:11e3,sourceType:"playlist",playlistId:t,trackId:s??0,trackIndex:a}).pipe(l(n=>n.success),r(n=>(console.error("Failed to play playlist on Bluesound:",n),i(!1))))}addToQueue(e,t){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/queue/add`,{trackId:t}).pipe(l(()=>!0),r(()=>i(!1)))}clearQueue(e){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/queue/clear`,{}).pipe(l(()=>!0),r(()=>i(!1)))}playQueueItem(e,t){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/queue/play`,{index:t}).pipe(l(()=>!0),r(()=>i(!1)))}removeQueueItem(e,t){return this.http.delete(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/queue/${t}`).pipe(l(()=>!0),r(()=>i(!1)))}getQobuzQuality(e){return this.http.get(`${this.qobuzApiUrl}/bluesound/quality?playerIp=${encodeURIComponent(e)}`).pipe(l(t=>t.success?{quality:t.quality,formatId:t.formatId}:null),r(()=>i(null)))}setQobuzQuality(e,t){return this.http.post(`${this.qobuzApiUrl}/bluesound/quality`,{playerIp:e,formatId:t}).pipe(l(a=>a.success),r(()=>i(!1)))}createGroup(e,t){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/group/create`,{slaveIps:t}).pipe(l(()=>!0),r(()=>i(!1)))}addToGroup(e,t){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/group/add`,{slaveIp:t}).pipe(l(()=>!0),r(()=>i(!1)))}removeFromGroup(e,t){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/group/remove`,{slaveIp:t}).pipe(l(()=>!0),r(()=>i(!1)))}leaveGroup(e){return this.http.post(`${this.apiBaseUrl}/player/${encodeURIComponent(e)}/group/leave`,{}).pipe(l(()=>!0),r(()=>i(!1)))}static \u0275fac=function(t){return new(t||d)};static \u0275prov=c({token:d,factory:d.\u0275fac,providedIn:"root"})};var E=class d{playerState=p(m);bluesoundApi=p(b);qobuzApi=p(I);audioElement=null;animationFrameId=null;lastProgressUpdate=0;currentContext=null;destroy$=new g;pollingSubscription=null;isLoading=h(!1);loadingTrackId=h(null);isBrowserPlaying=h(!1);constructor(){this.initAudioElement(),this.setupModeWatcher()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.stopProgressAnimation(),this.disposeAudioElement(),this.stopPolling()}initAudioElement(){typeof window<"u"&&(this.audioElement=new Audio,this.audioElement.preload="metadata",this.audioElement.addEventListener("play",()=>this.onAudioPlay()),this.audioElement.addEventListener("pause",()=>this.onAudioPause()),this.audioElement.addEventListener("ended",()=>this.onAudioEnded()),this.audioElement.addEventListener("timeupdate",()=>this.onTimeUpdate()),this.audioElement.addEventListener("loadedmetadata",()=>this.onLoadedMetadata()),this.audioElement.addEventListener("error",e=>this.onAudioError(e)))}disposeAudioElement(){this.audioElement&&(this.audioElement.pause(),this.audioElement.src="",this.audioElement=null)}setupModeWatcher(){}async playTrack(e,t){this.isLoading.set(!0),this.loadingTrackId.set(e.id);try{this.playerState.currentTrack.set(e),this.playerState.setCurrentPlayingTrackId(e.id),this.playerState.duration.set(e.duration||0),this.playerState.progress.set(0),t&&(this.currentContext=t),this.playerState.playerMode()==="browser"?await this.playTrackInBrowser(e):await this.playTrackOnBluesound(e,t)}catch(a){console.error("Failed to play track:",a)}finally{this.isLoading.set(!1),this.loadingTrackId.set(null)}}async playAlbum(e,t,a=0){if(!e.id){console.error("Album has no ID");return}let s=t[a];if(!s){console.error("Invalid start index");return}let n={type:"album",id:e.id,tracks:t,startIndex:a},u=this.playerState.playerMode(),y=this.playerState.selectedPlayer();if(u==="bluesound"&&y){this.isLoading.set(!0);try{this.playerState.currentTrack.set(s),this.playerState.setCurrentPlayingTrackId(s.id),await o(this.bluesoundApi.playQobuzAlbum(y.ipAddress,e.id,a,s.id)),this.currentContext=n,this.startPolling()}finally{this.isLoading.set(!1)}}else await this.playTrack(s,n)}async playPlaylist(e,t,a=0){let s=t[a];if(!s){console.error("Invalid start index");return}let n={type:"playlist",id:e.id,tracks:t,startIndex:a},u=this.playerState.playerMode(),y=this.playerState.selectedPlayer();if(u==="bluesound"&&y){this.isLoading.set(!0);try{this.playerState.currentTrack.set(s),this.playerState.setCurrentPlayingTrackId(s.id),await o(this.bluesoundApi.playQobuzPlaylist(y.ipAddress,e.id,a,s.id)),this.currentContext=n,this.startPolling()}finally{this.isLoading.set(!1)}}else await this.playTrack(s,n)}async playTrackInBrowser(e){if(this.audioElement)try{let t=this.playerState.streamingQuality(),a=await o(this.qobuzApi.getTrackStreamUrl(e.id,t));this.audioElement.pause(),this.audioElement.src=a,this.audioElement.volume=this.playerState.isMuted()?0:this.playerState.volume()/100,await this.audioElement.play(),this.startProgressAnimation()}catch(t){throw console.error("Failed to play track in browser:",t),t}}async playTrackOnBluesound(e,t){let a=this.playerState.selectedPlayer();if(!a){console.error("No Bluesound player selected");return}if(!t){console.error("No playback context provided - Bluesound native playback requires album/playlist context");return}try{let s=t.type==="album"?{type:"album",albumId:String(t.id)}:{type:"playlist",playlistId:Number(t.id)};await o(this.bluesoundApi.playQobuzTrackNative(a.ipAddress,e.id,t.startIndex,s))||console.error("Bluesound native playback returned false"),this.startPolling()}catch(s){throw console.error("Failed to play track on Bluesound:",s),s}}async togglePlayPause(){let e=this.playerState.playerMode(),t=this.playerState.isPlaying();if(e==="browser")this.audioElement&&(t||!this.audioElement.paused?this.audioElement.pause():(await this.audioElement.play(),this.startProgressAnimation()));else{let a=this.playerState.selectedPlayer();a&&(t?await o(this.bluesoundApi.pause(a.ipAddress)):await o(this.bluesoundApi.play(a.ipAddress)))}}async play(){if(this.playerState.playerMode()==="browser")this.audioElement&&this.audioElement.paused&&(await this.audioElement.play(),this.startProgressAnimation());else{let t=this.playerState.selectedPlayer();t&&await o(this.bluesoundApi.play(t.ipAddress))}}async pause(){if(this.playerState.playerMode()==="browser")this.audioElement?.pause();else{let t=this.playerState.selectedPlayer();t&&await o(this.bluesoundApi.pause(t.ipAddress))}}async stop(){if(this.playerState.playerMode()==="browser")this.audioElement&&(this.audioElement.pause(),this.audioElement.currentTime=0),this.stopProgressAnimation(),this.playerState.reset();else{let t=this.playerState.selectedPlayer();t&&await o(this.bluesoundApi.stop(t.ipAddress))}}async skipNext(){if(this.playerState.playerMode()==="browser"){if(this.currentContext){let t=this.currentContext.startIndex+1;t<this.currentContext.tracks.length&&(this.currentContext.startIndex=t,await this.playTrack(this.currentContext.tracks[t],this.currentContext))}}else{let t=this.playerState.selectedPlayer();t&&await o(this.bluesoundApi.skip(t.ipAddress))}}async skipPrevious(){if(this.playerState.playerMode()==="browser"){if(this.audioElement&&this.audioElement.currentTime>3){this.audioElement.currentTime=0;return}if(this.currentContext){let t=this.currentContext.startIndex-1;t>=0&&(this.currentContext.startIndex=t,await this.playTrack(this.currentContext.tracks[t],this.currentContext))}}else{let t=this.playerState.selectedPlayer();t&&await o(this.bluesoundApi.back(t.ipAddress))}}async seek(e){if(this.playerState.playerMode()==="browser")this.audioElement&&(this.audioElement.currentTime=e,this.playerState.updateProgress(e));else{let a=this.playerState.selectedPlayer();a&&await o(this.bluesoundApi.seek(a.ipAddress,e))}}async seekToPercent(e){let t=this.playerState.duration();if(t>0){let a=e/100*t;await this.seek(a)}}async setVolume(e){let t=Math.max(0,Math.min(100,e));if(this.playerState.setVolume(t),this.playerState.playerMode()==="browser")this.audioElement&&(this.audioElement.volume=t/100);else{let s=this.playerState.selectedPlayer();s&&!s.isFixedVolume&&await o(this.bluesoundApi.setVolume(s.ipAddress,t))}}async toggleMute(){let e=this.playerState.isMuted();if(this.playerState.toggleMute(),this.playerState.playerMode()==="browser")this.audioElement&&(this.audioElement.volume=e?this.playerState.volume()/100:0);else{let a=this.playerState.selectedPlayer();a&&await o(this.bluesoundApi.setMute(a.ipAddress,!e))}}async setQuality(e){this.playerState.setStreamingQuality(e);let t=this.playerState.selectedPlayer();if(t&&this.playerState.playerMode()==="bluesound")try{await o(this.bluesoundApi.setQobuzQuality(t.ipAddress,e))}catch(a){console.error("Failed to set quality on Bluesound player:",a)}}async loadQualityFromPlayer(){let e=this.playerState.selectedPlayer();if(e&&this.playerState.playerMode()==="bluesound")try{let t=await o(this.bluesoundApi.getQobuzQuality(e.ipAddress));t&&this.playerState.setStreamingQuality(t.formatId)}catch(t){console.error("Failed to load quality from Bluesound player:",t)}}async switchToBrowser(){let e=this.playerState.selectedPlayer();if(e)try{await o(this.bluesoundApi.stop(e.ipAddress))}catch{}this.stopPolling(),this.playerState.useBrowserPlayback()}async switchToBluesound(e){let t=this.isBrowserPlaying(),a=this.playerState.currentTrack(),s=this.currentContext;if(this.audioElement&&(this.audioElement.pause(),this.audioElement.src=""),this.stopProgressAnimation(),this.playerState.selectPlayer(e),this.startPolling(),await this.loadQualityFromPlayer(),t&&a&&s){let n=s.tracks.findIndex(y=>y.id===a.id),u=n>=0?n:s.startIndex;s.type==="album"?await o(this.bluesoundApi.playQobuzAlbum(e.ipAddress,s.id,u,a.id)):s.type==="playlist"?await o(this.bluesoundApi.playQobuzPlaylist(e.ipAddress,s.id,u,a.id)):await this.playTrackOnBluesound(a,s)}}onAudioPlay(){this.isBrowserPlaying.set(!0);let e=this.playerState.playbackStatus();if(e)this.playerState.updatePlaybackStatus(f(v({},e),{state:"play"}));else{let t=this.playerState.currentTrack();t&&this.playerState.updatePlaybackStatus({state:"play",title:t.title,artist:t.performer?.name,album:t.album?.title,imageUrl:t.album?.image?.large,totalSeconds:t.duration,currentSeconds:0,artistId:t.performer?.id})}}onAudioPause(){this.isBrowserPlaying.set(!1),this.stopProgressAnimation();let e=this.playerState.playbackStatus();e&&this.playerState.updatePlaybackStatus(f(v({},e),{state:"pause"}))}onAudioEnded(){this.isBrowserPlaying.set(!1),this.stopProgressAnimation(),this.currentContext&&this.skipNext()}onTimeUpdate(){this.audioElement&&this.playerState.updateProgress(this.audioElement.currentTime)}onLoadedMetadata(){this.audioElement&&this.playerState.duration.set(this.audioElement.duration)}onAudioError(e){console.debug("Audio element error (expected for device playback):",e),this.isBrowserPlaying.set(!1),this.stopProgressAnimation()}startProgressAnimation(){this.stopProgressAnimation(),this.lastProgressUpdate=performance.now(),this.animateProgress()}stopProgressAnimation(){this.animationFrameId!==null&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animateProgress=()=>{if(!this.audioElement||this.audioElement.paused)return;let e=performance.now(),t=(e-this.lastProgressUpdate)/1e3;this.lastProgressUpdate=e;let s=this.playerState.progress()+t;s<=this.playerState.duration()&&this.playerState.updateProgress(s),this.animationFrameId=requestAnimationFrame(this.animateProgress)};startPolling(){this.stopPolling();let e=this.playerState.selectedPlayer();e&&(this.pollingSubscription=P(1e3).pipe(A(this.destroy$),S(()=>this.bluesoundApi.getStatus(e.ipAddress))).subscribe(t=>{t&&this.playerState.updatePlaybackStatus(t)}))}stopPolling(){this.pollingSubscription&&(this.pollingSubscription.unsubscribe(),this.pollingSubscription=null)}async addToQueue(e){let t=this.playerState.playerMode(),a=this.playerState.selectedPlayer();t==="bluesound"&&a?await o(this.bluesoundApi.addToQueue(a.ipAddress,e.id)):this.currentContext&&this.currentContext.tracks.push(e)}async clearQueue(){let e=this.playerState.playerMode(),t=this.playerState.selectedPlayer();e==="bluesound"&&t&&await o(this.bluesoundApi.clearQueue(t.ipAddress)),this.playerState.clearQueue(),this.currentContext=null}async loadQueue(){let e=this.playerState.selectedPlayer();if(!e)return;let t=await o(this.bluesoundApi.getQueue(e.ipAddress));this.playerState.setQueue(t)}static \u0275fac=function(t){return new(t||d)};static \u0275prov=c({token:d,factory:d.\u0275fac,providedIn:"root"})};export{b as a,E as b};
